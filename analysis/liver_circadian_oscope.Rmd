---
title: 'Liver single-cell data analysis: oscope circadian expression cycle analysis'
author: "Jon Thompson, Pers lab, rkm916 at ku dot dk"
date: "`r Sys.time()`" 
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
params: 
  date: !r substr(gsub("-","",as.character(Sys.Date())),3,1000)
  randomSeed: !r 12345
  pValThreshold: !r 0.05
# output:
#   html_notebook:
#     df_print: paged
#     number_sections: yes
#     toc: yes
#     toc_depth: 3
#     toc_float: yes
#   html_document:
#     df_print: paged
#     number_sections: yes
#     toc: yes
#     toc_depth: 3
#     toc_float: yes
---

# Setup

## Set options

```{r}
options(stringsAsFactors = F,
        use="pairwise.complete.obs",
        warn=1,
        verbose=F,
        mc.cores=40# for parallel computation
        )
```

## source utility functions

```{r}

source("./perslab-sc-library/utility_functions.R")
source("./perslab-sc-library/functions_sc.R")
```

## Load packages

```{r}
#devtools::install_github(repo = "satijalab/seurat", ref = "develop") # dev version of Seurat

library(Seurat)

library(Matrix)
library(parallel)
library(tidyverse)
#library(AUCell)
library(Oscope)
library(openxlsx)
library(here)
#ipak(c("Seurat", "dplyr", "ggplot2", "Matrix", "parallel", "readr", "tidyr",  "AUCell", "Oscope", "openxlsx", "here"))
```

## Set constants

```{r}
randomSeed = 12345
set.seed(randomSeed)

pValThreshold = 0.05
pval.adjust.method = "BH"
```

generic project constants 

```{r}
prefixData = "liver_perslab_int"
prefixRun = "seurat_7"
prefixOut = "SCTint_perslab_labels"
```

## specific options and params

```{r}
options(future.globals.maxSize = 8000 * 1024^2)
nCores=  20
npcs=60
res_primary=0.8
```

## load data

```{r}
#pathSeuratObj <- dir(path=here("output"), pattern = paste0(".*",prefixRun, "_", prefixOut, ".*\\.RDS\\.gz"), full.names = T)
pathSeuratObj <- here("output", paste0(prefixData,"_",prefixRun, "_", prefixOut, "_seuratObj.RDS.gz"))
seuratObj <- load_obj(pathSeuratObj)
```

```{r}
head(seuratObj@meta.data)
```


## Oscope circadian analysis

https://www.bioconductor.org/packages/devel/bioc/vignettes/Oscope/inst/doc/Oscope_vignette.pdf

Oscope uses co-regulation information among genes, considered as oscillators, to identify groups of putative oscillating (co-exrepessed)genes.

Scope then reconstructs the cyclic order of samples for each group.

The reconstructed order is based on minimizing distance between each gene’s expression and its gene-specific profile defined by the group’s base cycle allowing for phaseshifts between different genes.

For different groups of genes following independent oscillatory processes and/or having distinct frequencies, the cyclic orders need not be the same.

For expected circadian genes see https://www.nature.com/articles/nature744

### Normalize
Cross-sample library size normalization should be performed.

```{r}
seuratObj@active.assay <- "SCT"
```

```{r}
seuratObj <-  SCTransform(seuratObj,
                              vars.to.regress = NULL, #  Variables to regress out in a second non-regularized linear regression. For example, percent.mito. Default is NULL
                              do.correct.umi=T,
                              do.scale=F,
                              do.center=F,
                              return.only.var.genes =F,
                              seed.use = randomSeed,
                              verbose=T)
```

```{r}
DataNorm <- GetAssayData(seuratObj, assay="SCT", slot="counts") %>% as.matrix
```

### Subset variable genes

```{r}
seuratObj <- FindVariableFeatures(object = seuratObj)
```

```{r}
DataSubset2 <- DataNorm[VariableFeatures(seuratObj, assay="SCT"),]
```

### rescale to [-1,1]

```{r}
DataInput <- Oscope::NormForSine(DataSubset2)
```

## Paired-sine model

We developed a paired-sine model to identify gene pairs that are oscillating following the same process. 
Genes following the same process are assumed to have same frequency, but allow for phase shifts.

```{r}
SineRes <- Oscope::OscopeSine(DataInput, 
                              parallel = F)
str(SineRes)
```

The output of OscopeSine()contains 3 matrices.
* SimiMat shows the sine score between each pair of input genes. The higher the sine score, the more likely that two genes are oscillating following the same process.  
* DiffMat shows the distance (dissimilarity estimates) between each pair of genes. Note that sine score = -log10 (distance) for any pair of genes. 
* ShiftMatshows the estimated phase shift between each pair of genes.

### K-medoids algorithm

Oscope incorporated a K-medoids algorithm to cluster candidate oscillatory gene pairs iden-tified by the paired-sine model into gene groups. Function OscopeKM() may be used to apply the K-medoids algorithm. The K-mediods algorithm uses the distance matrix estimated in the paired-sine model as the dissimilarity metric.
* By setting maxK = 10,OscopeKM() function will search for the optimal K among 2-10 by maximizing the Silhouette distance
* By default settings, the top 5% genes willbe used in the K-medoids clustering
* If maxK is not specified, it will be set to the integer part of (number of topgenes)/10

```{r}
KMRes <- OscopeKM(SineRes, maxK = 10)
# gene pairs above this threshold are considered:
# -3.62558686092477
# max number of clusters considered:10
# optimal number of clusters:4
```

```{r}
print(KMRes)
```

### Flag clusters with small within-cluster sine scores and/or small within-cluster phase shifts

* each gene has a sine function fit score
* To infer the significance of each group, Oscope evaluates each group’s sine score distribution using permuted data.
* By default, Oscope only takes groups whose median sine score in original data is greater than its 90th quantile in permuted data

To avoid detecting gene groups with purely linear relationship but no phase shift, i.e. no oscillation, we suggest users to only consider gene clusters with some within-group phase differences. For any pair of genesgi,gjwithin a group, defineυgi,gj=min((π−ηgi,gj),ηgi,gj), in whichηgi,gj=ψgi,gjmodπ.Oscope’s default takes groups whose 90thquantile ofυgi,gj’s is greater thanπ/4for furtherorder recovery. FunctionFlagCluster()could also flag gene clusters with small within-clusterphase shifts.

```{r}
ToRM <- FlagCluster(SineRes, 
                    KMRes, 
                    DataInput)
```

```{r}
print(ToRM$FlagID_bysine)
# integer(0)
```

```{r}
print(ToRM$FlagID_byphase)
# 1
```

```{r}
KMResUse <- KMRes[-ToRM$FlagID]
print(KMResUse)
```

## Extended nearest insertion

Oscope reconstructs the base cycle order for each of the selected gene clusters. To reconstruct the base cycle orders, the OscopeENI() function may be used

```{r}
ENIRes <- OscopeENI(KMRes = KMResUse, 
                    Data = DataInput, 
                    NCThre = 1000, # number of iterations before stopping, default value 1000
                    parallel=T,
                    parallelParam = SnowParam(workers=nCores, type="FORK"))
print(ENIRes)
```

Once the recovered cell orders are obtained, a user may reorder the expression matrix andapply ordinary time series methods (e.g. FFT) on all the genes to find weaker oscillators (andoscillators with lower mean or variance, if only high mean high vanriance genes are used inprevious steps). For example, the reordered data set may be obtained by:

[....]
# TODO 

save in order to transfer labels using a separate script 

```{r}
saveMeta(savefnc = saveRDS, object =seuratObj, file = here("output", paste0(prefixData, "_", prefixRun, "_", prefixOut, "seuratObj.RDS.gz")), compress="gzip")
```




