---
title: 'Liver project Seurat post-processing 2019.05'
author: "Jon Thompson, Pers lab"
date: "`r Sys.time()`" 
params:
  pvalThreshold: !r 5e-2
  flagDate: !r substr(gsub("-","",as.character(Sys.Date())),3,1000)

output:
  html_notebook: 
    df_print: paged
    number_sections: yes
    toc: yes
    toc_depth: 3
    toc_float: yes
---

See also previous script: ./liver_seurat.Rmd

# Setup 

## options

```{r}

options(warn=1, stringsAsFactors = F, use= "pairwise.complete.obs")
```

## Load packages

```{r}
suppressPackageStartupMessages(library(Seurat))
suppressPackageStartupMessages(library(dplyr))
suppressPackageStartupMessages(library(Matrix))
suppressPackageStartupMessages(library(parallel))
suppressPackageStartupMessages(library(readxl))
suppressPackageStartupMessages(library(ggplot2))
suppressPackageStartupMessages(library(cowplot))

```

## Source functions and set session parameters and constants

```{r}

source("/projects/jonatan/tools/functions-src/utility_functions.R")

dirProject = "/projects/jonatan/applied/18-liver/"
dirRObjects = paste0(dirProject, "/RObjects/")
dirPlots = paste0(dirProject, "/plots/")
dirLog = paste0(dirProject, "/log/")
dirTables = paste0(dirProject, "/tables/")

prefixData = "liver_perslab_align"
prefixRun = "seurat_7"
```

## load data

```{r}
pathSeuratObj <- dir(path=dirRObjects, pattern = paste0(".*",prefixRun, ".*\\.RDS\\.gz"), full.names = T)
seuratObj <- load_obj(pathSeuratObj)
```


### Visualise effects of different mito/ribo cutoffs

```{r}
seuratObj$percent.ribo_0.28 <- seuratObj$percent.ribo <= 0.28 
seuratObj$percent.ribo_0.26 <- seuratObj$percent.ribo <= 0.26
seuratObj$percent.ribo_0.24 <- seuratObj$percent.ribo <= 0.24
seuratObj$percent.ribo_0.22 <- seuratObj$percent.ribo <= 0.22 
seuratObj$percent.ribo_0.20 <- seuratObj$percent.ribo <= 0.20
seuratObj$percent.ribo_0.18 <- seuratObj$percent.ribo <= 0.18
seuratObj$percent.ribo_0.16 <- seuratObj$percent.ribo <= 0.16
seuratObj$percent.ribo_0.14 <- seuratObj$percent.ribo <= 0.14
seuratObj$percent.ribo_0.14 <- seuratObj$percent.ribo <= 0.12
```

```{r}
seuratObj$percent.mito_0.38 <- seuratObj$percent.mito <= 0.38
seuratObj$percent.mito_0.36 <- seuratObj$percent.mito <= 0.36
seuratObj$percent.mito_0.34 <- seuratObj$percent.mito <= 0.34
seuratObj$percent.mito_0.32 <- seuratObj$percent.mito <= 0.32
seuratObj$percent.mito_0.30 <- seuratObj$percent.mito <= 0.30
seuratObj$percent.mito_0.28 <- seuratObj$percent.mito <= 0.28
seuratObj$percent.mito_0.26 <- seuratObj$percent.mito <= 0.26
seuratObj$percent.mito_0.24 <- seuratObj$percent.mito <= 0.24
seuratObj$percent.mito_0.24 <- seuratObj$percent.mito <= 0.22
```

```{r, fig.height=12, fig.height=12}

list_plot <- lapply("X"=grep(pattern="percent.ribo_0\\.\\d{2}$",x = colnames(seuratObj@meta.data), value=T), FUN = function(groupName) {
  DimPlot(object = seuratObj,  group.by=groupName, pt.size = 0.75, title = groupName)
}) 

p1<- cowplot::plot_grid(plotlist = list_plot,
                        ncol= (list_plot %>% length %>% sqrt %>% as.integer),
                        labels=as.list(grep(pattern="percent.ribo_0\\.\\d{2}$",x = colnames(seuratObj@meta.data), value=T)))

saveMeta(savefnc = cowplot::save_plot, plot=p1,
          ncol= (list_plot %>% length %>% sqrt %>% as.integer),
          filename =  paste0(dirPlots, prefixData, "_", prefixRun, "_ribo_QCplotgrid.pdf"),
          base_height = 15, # of a subplot
          #base_width = 5,
          base_aspect_ratio = 0.4,
          limitsize=F)
```


```{r, fig.height=12, fig.height=12}

list_plot <- lapply("X"=grep(pattern="percent.mito_0\\.\\d{2}$",x = colnames(seuratObj@meta.data), value=T), FUN = function(groupName) {
  DimPlot(object = seuratObj,  group.by=groupName, pt.size = 0.75, title = groupName)
}) 

p1<- cowplot::plot_grid(plotlist = list_plot,
                        ncol= (list_plot %>% length %>% sqrt %>% as.integer), 
                        labels=as.list(grep(pattern="percent.mito_0\\.\\d{2}$",x = colnames(seuratObj@meta.data), value=T)))

saveMeta(savefnc = cowplot::save_plot, plot=p1,
          ncol= (list_plot %>% length %>% sqrt %>% as.integer),
          filename =  paste0(dirPlots, prefixData, "_", prefixRun, "_mito_QCplotgrid.pdf"),
          base_height = 15, # of a subplot
          #base_width = 5,
          base_aspect_ratio = 0.4,
          limitsize=F)
```

### Visualise effects of different min nCount_RNA cutoffs
```{r}

seuratObj$min_nCount_RNA_1050 <- seuratObj$nCount_RNA >= 1050
seuratObj$min_nCount_RNA_1100 <- seuratObj$nCount_RNA >= 1100
seuratObj$min_nCount_RNA_1150 <- seuratObj$nCount_RNA >= 1150
seuratObj$min_nCount_RNA_1200 <- seuratObj$nCount_RNA >= 1200
seuratObj$min_nCount_RNA_1250 <- seuratObj$nCount_RNA >= 1250
seuratObj$min_nCount_RNA_1300 <- seuratObj$nCount_RNA >= 1300
seuratObj$min_nCount_RNA_1350 <- seuratObj$nCount_RNA >= 1350
seuratObj$min_nCount_RNA_1400 <- seuratObj$nCount_RNA >= 1400
seuratObj$min_nCount_RNA_1450 <- seuratObj$nCount_RNA >= 1450
seuratObj$min_nCount_RNA_1500 <- seuratObj$nCount_RNA >= 1500

```
 
```{r, fig.height=12, fig.height=12}

list_plot <- lapply("X"=grep(pattern="min_nCount_RNA_.+",x = colnames(seuratObj@meta.data), value=T), FUN = function(groupName) {
  DimPlot(object = seuratObj,  group.by=groupName, pt.size = 0.75, title = groupName)
}) 

p1<- cowplot::plot_grid(plotlist = list_plot,
                          ncol= (list_plot %>% length %>% sqrt %>% as.integer),
                        labels  = as.list(grep(pattern="min_nCount_RNA_.+",x = colnames(seuratObj@meta.data), value=T)))

saveMeta(savefnc = cowplot::save_plot, plot=p1,
          ncol= (list_plot %>% length %>% sqrt %>% as.integer),
          filename =  paste0(dirPlots, prefixData, "_", prefixRun, "_min_nCount_RNA_QCplotgrid.pdf"),
          base_height = 15, # of a subplot
          #base_width = 5,
          base_aspect_ratio = 0.4,
          limitsize=F)
```

