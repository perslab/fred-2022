---
title: 'Liver - gene network plots'
author: "Jon Thompson, Pers lab, rkm916 at ku dot dk"
date: "`r Sys.time()`" 
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
params: 
  date: !r substr(gsub("-","",as.character(Sys.Date())),3,1000)
  randomSeed: !r 12345
  pValThreshold: !r 0.05
# output:
#   html_notebook:
#     df_print: paged
#     number_sections: yes
#     toc: yes
#     toc_depth: 3
#     toc_float: yes
#   html_document:
#     df_print: paged
#     number_sections: yes
#     toc: yes
#     toc_depth: 3
#     toc_float: yes
---

# Setup

## Set options

```{r}
options(stringsAsFactors = F, 
        use="pairwise.complete.obs", 
        warn=1, 
        verbose=F,
        mc.cores=40 # for parallel computation
        ) 
```

```{r}
randomSeed = 12345
set.seed(randomSeed)

pval.adjust.method = "BH"
pValThreshold = 0.05 #params$pValThreshold

flagDate = substr(gsub("-","",as.character(Sys.Date())),3,1000)
```

## Load packages

```{r}
#ipak(c("Seurat", "dplyr", "ggplot2", "Matrix", "parallel", "readr", "tidyr"))
library("Seurat")
library("data.table")
library("dplyr")
library("ggplot2")
library("Matrix")
library("parallel")
#library("readr")
library("tidyr")
library("here")
#library("lme4")
#library("WGCNA")
#library("dendextend")
#library("ggdendro")
library("ComplexHeatmap")
library("corrplot")
#devtools::install_github(repo = "satijalab/seurat", ref = "develop")
```

## source utility functions

```{r}
source(here("/perslab-sc-library", "utility_functions.R"))
source(here("perslab-sc-library", "functions_sc.R"))
```

## Set constants

generic project constants 

```{r}
#prefixData <- "aizarani"
prefixData = "liver_perslab_int"
prefixRun = "seurat_7"
#prefixOut <- "SCT"
prefixOut <- "SCTint"

dirWGCNA_outs = "/projects/jonatan/pub-perslab/18-liver-wgcna/"
dirWGCNA_plots = paste0(dirWGCNA_outs, "plots/" )
dirWGCNA_RObjects = paste0(dirWGCNA_outs, "RObjects/" )
dirWGCNA_tables = paste0(dirWGCNA_outs, "tables/" )

colModule = "module"
colCellCluster = "cell_cluster"
```

we are interested in a subset of the "cluster_perslab_coarse" cell types
```{r}
vec_celltypesOfInterest <- c("T-cells-alpha-beta",
                             "NK-like-cells",
                             "Endothelial-cells",
                             "T-cells-gamma-delta", 
                             "Macrophages",  
                             "Cholangiocytes",        
                             "Hepatocytes",
                             "Hepatic-stellate-cells", 
                             "Dendritic-cells", 
                             "Hepatic-stem-cells")
```

## load data

Seurat object contains expression data and cell + patient-level metadata

```{r}
# path_seuratObj <- here("output", paste0(prefixData, "_", prefixRun, "_", prefixOut, "_perslab_labels_seuratObj.RDS.gz"))
path_seuratObj <- here("output", paste0(prefixData, "_", prefixRun, "_", prefixOut, "_perslab_labels_seuratObj_combat.RDS.gz"))

seuratObj <- load_obj(path_seuratObj)
```

```{r}
Idents(seuratObj) <- seuratObj$cluster_perslab_coarse

seuratObj_sub <- subset(x=seuratObj,
                    idents=vec_celltypesOfInterest)
```

load gene module cell embedding matrix

```{r}
path_cellModEmbed <-  paste0(dirWGCNA_tables, prefixData, "_wgcna2_kIM_cellModEmbed.csv.gz")
  
dt_cellModEmbed <- fread(path_cellModEmbed)

dt_cellModEmbed[0:6,0:7]
```

filter 

```{r}

vec_celltypesOfInterest %>% gsub("-","_",.) %>% lapply(., function(eachName) grepl(eachName,colnames(dt_cellModEmbed))) %>% Reduce(f = '|',x=.) %>% which -> vec_colsOfInterest

```

```{r}
dt_cellModEmbed_sub <- dt_cellModEmbed[,c(1:3, ..vec_colsOfInterest),]


colnames(dt_cellModEmbed_sub)
```

```{r}
dt_cellModEmbed_sub <- dt_cellModEmbed_sub[cell_id %in% rownames(seuratObj_sub@meta.data)]
```

```{r}
dim(dt_cellModEmbed_sub)
# []] 19139   130
```

127 modules

load data frame with information on module and cell type of origin

```{r}
path_geneModule <- paste0(dirWGCNA_tables,"liver_perslab_int_wgcna2_cell_cluster_module_genes.csv.gz")
  
dt_geneModule <-fread(file=path_geneModule)

head(dt_geneModule)

#                 data    run   cell_cluster     module         genes      pkMs
# 1: liver_perslab_int wgcna2 B_cells_mature indianred3 RP13-580B18.4 0.4231437
# 2: liver_perslab_int wgcna2 B_cells_mature indianred3    CYB561D2.1 0.4226896
# 3: liver_perslab_int wgcna2 B_cells_mature indianred3         INSL6 0.4225327
# 4: liver_perslab_int wgcna2 B_cells_mature indianred3        VSTM2B 0.4223379
# 5: liver_perslab_int wgcna2 B_cells_mature indianred3 RP11-822E23.7 0.4222782
# 6: liver_perslab_int wgcna2 B_cells_mature indianred3       NUP62CL 0.4218757
```

```{r}
vec_celltypesOfInterest %>% gsub("-","_",.) -> vec_tmp
dt_geneModule_sub <- dt_geneModule[cell_cluster %in% c("T_cells_alpha_beta", "NK_like_cells", "Endothelial_cells",  "T_cells_gamma_delta", "Macrophages", "Cholangiocytes", "Hepatocytes", "Hepatic_stellate_cells",
"Dendritic_cells","Hepatic_stem_cells")]

dt_geneModule_sub
```

```{r}
path_dt_metadataCombined <- here("data", "metadataCombined.csv")
dt_metadataCombined<-fread(file=path_dt_metadataCombined)

head(dt_metadataCombined)

#   ID      Age Sex Ethnicity      BMI Smoking Alcohol_use nas_sum fibrosis_grade lobular_inflammation_grade
# 1: 235L 44.55068   0    Danish 35.15850       1           1       6              2                          2
# 2: 242L 53.32055   1    Danish 37.48722       0           2       5              1                          2
# 3: 245L 43.53973   1    Danish 44.48491       1           1       5              2                          2
# 4: 247L 51.12603   0    Danish 52.65934       1           1       5              2                          2
# 5: 249L 64.40822   0    Danish 44.47846       1           1       4              2                          3
# 6: 252L 47.02192   1    Danish 44.85055       1           1       5              2                          2
```

# QC plotting

## correlation matrix 

Very high correlations between gene modules could indicate confounding

Even if serious confounding is not suspected, it may make sense to try to merge very overlapping and correlated modules across cell types, which the current cell-type-wise WGCNA workflow does not do.

```{r}
mat_modCor <- cor(x=dt_cellModEmbed_sub[,-c("data", "cell_cluster", "cell_id")],
                               use="pairwise.complete.obs",
                               method="pearson")

```

```{r}
pdf(file = here("plots", paste0(prefixData, "_" , prefixRun, "_", prefixOut, "_", flagDate, "_moduleCorr.pdf")), width=20, height=20)
corrplot::corrplot(corr = mat_modCor, method="number", number.cex = 0.5)
dev.off()
```

## gene module heatmaps

Get a visual snapshot of what drives module expression.
Does something look fishy? Does anything suggest confounding factors are driving differences in which cells have higher or lower gene module activity?

Order the rows by cell cluster

```{r}
dt_cellModEmbed_sub <- dt_cellModEmbed_sub[order(cell_cluster)]
```

The gene module embeddings are computed using the SC- normalized and ComBat corrected counts. 
Hence we need to z-score them to plot on a single heatmap

```{r}
dt_cellModEmbed_sub[,lapply(.SD, scale),, .SDcols=colnames(dt_cellModEmbed_sub[,-c("data", "cell_cluster", "cell_id")])] %>% as.matrix -> mat_cellModEmbed_sub_scaled 

colnames(mat_cellModEmbed_sub_scaled) %>% gsub("\\.V1","", .) -> colnames(mat_cellModEmbed_sub_scaled)

rownames(mat_cellModEmbed_sub_scaled) <- dt_cellModEmbed_sub[,c("cell_id")][[1]]

mat_cellModEmbed_sub_scaled[0:4,0:4]

#                   Cholangiocytes__aliceblue.V1 Cholangiocytes__azure2.V1 Cholangiocytes__black.V1 Cholangiocytes__chocolate.V1
# TGTCCCACAATGAATG_1                    2.4859331              -0.009620634             -0.001129782                 -0.007353158
# AAACGGGGTCTACCTC_1                    0.7263057              -0.009620634             -0.001129782                 -0.007353158
# AAGTCTGGTAATAGCA_1                   -1.6010004              -0.009620634             -0.001129782                 -0.007353158
# AATCGGTCATGATCCA_1                    3.4825015              -0.009620634             -0.001129782                 -0.007353158
```

<!-- Find locations for cell type labels halfway through cell types in rows -->

<!-- ```{r} -->
<!-- vec_cellClustTable <- table(dt_cellModEmbed_sub[,cell_cluster,]) -->
<!-- vec_cellClustCumsum <- cumsum(c(1,vec_cellClustTable))  -->
<!-- vec_cellClustPos <- sapply(2:length(vec_cellClustCumsum), function(i) { -->
<!--   as.integer(vec_cellClustCumsum[i-1]+vec_cellClustTable[i-1]/2) -->
<!-- }) -->
<!-- ``` -->

# make colors to identify cell clusters in row annotation

```{r}
set.seed(randomSeed)
vec_colorCellClust = sample(x=unique(gsub("\\d","",colors())), size=length(unique(dt_cellModEmbed_sub[,cell_cluster,])), replace=F)
names(vec_colorCellClust) =unique(dt_cellModEmbed_sub[,cell_cluster,])
vec_colorCellClust
```

# make colors to identify sample_ID in row annotation

```{r}
set.seed(randomSeed)
vec_colorSampleID = sample(x=unique(gsub("\\d","",colors())), size=length(unique(seuratObj_sub$sample_ID)), replace=F)
names(vec_colorSampleID) =unique(seuratObj_sub$sample_ID)
vec_colorSampleID

```
<!-- Find locations for labels halfway through sample_ID in rows -->

<!-- ```{r} -->

<!-- vec_cellClustTable <- table(dt_cellModEmbed_sub[,cell_cluster,]) -->
<!-- vec_cellClustCumsum <- cumsum(c(1,vec_cellClustTable))  -->
<!-- vec_cellClustPos <- sapply(2:length(vec_cellClustCumsum), function(i) { -->
<!--   as.integer(vec_cellClustCumsum[i-1]+vec_cellClustTable[i-1]/2) -->
<!-- }) -->
<!-- ``` -->

```{r}
pdf(file = here("plots", paste0(prefixData, "_" , prefixRun, "_", prefixOut, "_", flagDate, "_modEmbedHeatmap.pdf")), width=20, height=20)
p <- ComplexHeatmap::Heatmap(mat=mat_cellModEmbed_sub_scaled, 
                             name="Module embeddings",
                             row_title = "cell",
                             column_title = "gene module",
                             cluster_rows = FALSE,
                             #cluster_cols = FALSE,
                             show_row_names=FALSE,
                             use_raster = TRUE, 
                             raster_quality = 2) 



p <- p + HeatmapAnnotation(cell_cluster = dt_cellModEmbed_sub$cell_cluster,
    col = list(cell_cluster = vec_colorCellClust) ,
    which="row")

p <- p + HeatmapAnnotation(df = data.frame("sample_ID" = seuratObj_sub$sample_ID[match(dt_cellModEmbed_sub$cell_id, rownames(seuratObj_sub@meta.data))]),
    col = list(sample_ID = vec_colorSampleID),
    which="row")

# p <- p + HeatmapAnnotation(df = data.frame("cell_cluster" = mat_cellModEmbed_sub_scaled %>% colnames %>% gsub("__.*$","", .)),
#                            col = list(cell_cluster = vec_colorCellClust), 
#                            which="column")


draw(p)
dev.off()
```

# wrap up

## save subsetted files

```{r}
file.out.data = paste0(dirWGCNA_tables, prefixData, "_wgcna2_kIM_cellModEmbed_subCellClusters.csv")
saveMeta(savefnc = fwrite, 
         x = dt_cellModEmbed_sub, 
         file=file.out.data, 
         nThread=24, verbose=T)

R.utils::gzip(file.out.data, overwrite=TRUE) # gzip
```


```{r}
file.out.data = paste0(dirWGCNA_tables,"liver_perslab_int_wgcna2_cell_cluster_module_genes_subCellClusters.csv")

saveMeta(savefnc = fwrite, 
         x = dt_geneModule_sub, 
         file=file.out.data,
         nThread=24, verbose=T)

R.utils::gzip(file.out.data, overwrite=TRUE) # gzip
```

OOPS accidentally overwrote the full cell_cluster_module_genes.csv file!

NB: To avoid wasting harddrive space we do not save a copy of the seuratObj subset

NEXT: use gene_module_merge2.R to merge highly overlapping and correlated modules
