---
title: 'Epilepsy 10x samples v2 - gene ontology analysis (using gProfiler)'
author: "Jon Thompson, Pers lab"
date: "`r Sys.time()`" 
params: 
  date: !r Sys.time()
  randomSeed: !r 12345
  pValThreshold: !r 0.05
  padjMethod: "bonferroni"
output:
  html_notebook: 
  df_print: paged
number_sections: yes
toc: yes
toc_depth: 3
toc_float: yes
html_document:
  df_print: paged
---

Sources
https://www.bioconductor.org/packages/release/bioc/vignettes/topGO/inst/doc/topGO.pdf
http://bioconductor.org/packages/release/BiocViews.html#___OrgDb
GOSemSim: https://bioconductor.org/packages/release/bioc/vignettes/GOSemSim/inst/doc/GOSemSim.html

## Setup

## Set options


```{r}
options(stringsAsFactors = F, 
        use="pairwise.complete.obs", 
        warn=1)
```
## source functions

```{r}
source(file=here("perslab-sc-library", "utility_functions.R"))
source(file=here("perslab-sc-library","functions_sc.R"))
```

## Load packages

```{r}

library("dplyr")
library("Matrix")
library("parallel")
library("readr")
library("openxlsx")
library("data.table")
library("here")
library("gprofiler2")
# ipak(c("dplyr", "ggplot2", "Matrix", "parallel", "RColorBrewer", "readr", "pheatmap", "GOSemSim", "AnnotationHub","org.Hs.eg.db", "GSEABase"))#,"ComplexHeatmap", "liger", "WGCNA", "circlize", "xlsx"))
```

### constants 

```{r}
prefixData <- "liver_perslab_int"
prefixRun <-  "seurat_7"

colGeneNames = "genes"
colGeneWeights ="pkMs"
colModule = "module_assoc"
colCellCluster = "cell_cluster_assoc"

dirWGCNA_outs = "/projects/jonatan/pub-perslab/18-liver-wgcna/"
dirWGCNA_plots = paste0(dirWGCNA_outs, "plots/" )
dirWGCNA_RObjects = paste0(dirWGCNA_outs, "RObjects/" )
dirWGCNA_tables = paste0(dirWGCNA_outs, "tables/" )

```

```{r}
params = list("randomSeed"=12345, 
              "date"=substr(gsub("-","",as.character(Sys.Date())),3,1000), 
              "nrepBootstrap"=1e4, 
              "pValThreshold" =0.05)
padjMethod ="bonferroni"
set.seed(params$randomSeed)
nrepBootstrap = 10000
```

## load data

Load modules dataframe

```{r}
dt_geneMod_perslab <- fread("/projects/jonatan/pub-perslab/18-liver-wgcna/tables/liver_perslab_int_wgcna3_geneMod_merged.csv.gz")
head(dt_geneMod_perslab)
```

```{r}
dt_geneMod_gerhard2018 <- fread("/projects/jonatan/pub-perslab/18-liver-wgcna/tables/liver_gerhard2018_wgcna2_geneMod_merged.csv.gz")
head(dt_geneMod_gerhard2018)
```


## Analysis

prepare lists of vectors of module gene weights

```{r}
vec_mods_perslab <- unique(na.omit(dt_geneMod_perslab$module_assoc))
vec_mods_perslab <- vec_mods_perslab[nchar(vec_mods_perslab)>0]
vec_mods_perslab
```


```{r}
list_pkMs_perslab <- lapply(vec_mods_perslab, function(module) {
  vecOut<-dt_geneMod_perslab[[colGeneWeights]][dt_geneMod_perslab[[colModule]]==module]
  names(vecOut) <- dt_geneMod_perslab[["genes"]][dt_geneMod_perslab[[colModule]]==module]
  vecOut <- vecOut[!is.na(names(vecOut))]
  vecOut <- sort(vecOut, decreasing = T)
  vecOut
})
names(list_pkMs_perslab)<-vec_mods_perslab
head(list_pkMs_perslab[[1]])
```

```{r}
vec_mods_gerhard2018 <- unique(na.omit(dt_geneMod_gerhard2018$module_assoc))
vec_mods_gerhard2018 <- vec_mods_gerhard2018[nchar(vec_mods_gerhard2018)>0]
vec_mods_gerhard2018
```


```{r}
list_pkMs_gerhard2018 <- lapply(vec_mods_gerhard2018, function(module) {
  vecOut<-dt_geneMod_gerhard2018[[colGeneWeights]][dt_geneMod_gerhard2018[[colModule]]==module]
  names(vecOut) <- dt_geneMod_gerhard2018[["ensembl"]][dt_geneMod_gerhard2018[[colModule]]==module]
  vecOut <- sort(vecOut, decreasing = T)
  vecOut <- vecOut[!is.na(names(vecOut)) & nchar(names(vecOut))>0]
  vecOut
})
names(list_pkMs_gerhard2018)<-vec_mods_gerhard2018
head(list_pkMs_gerhard2018[[1]])
```

### run gprofiler 

run separately since the two datasets use different gene names, and we want to lose as little info as possible

by using bonferroni correction for multiple testing is it easy to calculate the correction across both runs (using our preferred correction)

```{r}

path_RD_perslab <- here("data", "gerhard2018_genesBackground.RDS.gz")

if (!file.exists(path_RDS_perslab)) {
dt_datExpr_perslab <- fread("./output/liver_perslab_int_seurat_7_datExpr_combat.csv.gz")
vec_genesBackground_perslab <- dt_datExpr_perslab$genes
saveRDS(vec_genesBackground_perslab, path_RDS_perslab, compress="gzip")
rm(dt_datExpr_perslab)
} else {
  vec_genesBackground_perslab <- readRDS(path_RDS_perslab)
}
```

```{r}
list_gost_perslab <- gprofiler2::gost(query=lapply(list_pkMs_perslab, names),
                                 organism = "hsapiens", 
                                 ordered_query = T, 
                                 significant=T,
                                 exclude_iea = T, 
                                 correction_method="bonferroni",
                                 user_threshold=params$pValThreshold,
                                 custom_bg = vec_genesBackground_perslab,
                                 sources=c("GO:BP", "GO:CC","GO:MF"))
```


```{r}
path_RDS_gerhard2018 <- here("data", "gerhard2018_genesBackground.RDS.gz")

if (!file.exists(path_RDS_gerhard2018)) {
dt_datExpr_gerhard2018 <- fread(here("data","gerhard2018_norm.counts.csv.gz"))
vec_genesBackground_gerhard2018 <- dt_datExpr_gerhard2018$gene
saveRDS(vec_genesBackground_gerhard2018, path_RDS_gerhard2018, compress="gzip")
rm(dt_datExpr_gerhard2018)
} else {
  vec_genesBackground_perslab <- readRDS(path_RDS_gerhard2018)
}
```

```{r}

```

```{r}
list_gost_gerhard2018 <- gprofiler2::gost(query=lapply(list_pkMs_gerhard2018, names),
                                 organism = "hsapiens", 
                                 ordered_query = T, 
                                 significant=T,
                                 exclude_iea = T, 
                                 correction_method="bonferroni",
                                 user_threshold=params$pValThreshold,
                                 custom_bg = vec_genesBackground_gerhard2018,
                                 sources=c("GO:BP", "GO:CC","GO:MF"))
```

## re-correct pvalues

TODO 

```{r}
head(list_gost_perslab$result)
```

```{r}
head(list_gost_gerhard2018$result)
```

## write out outputs

```{r}
fwrite(list_gost_perslab$result, paste0(dirWGCNA_tables, prefixData,"_",prefixRun,"_GOgprofiler2_perslab_mods_full.csv"))
```

```{r}
openxlsx::write.xlsx(x=list_gost_perslab$result, file = paste0(dirWGCNA_tables, prefixData,"_",prefixRun,"_GOgprofiler2_perslab_mods_full.xlsx"))
```

```{r}
fwrite(list_gost_gerhard2018$result, paste0(dirWGCNA_tables, prefixData,"_",prefixRun,"_GOgprofiler2_gerhard2018_mods_full.csv"))
```

```{r}
openxlsx::write.xlsx(x=list_gost_gerhard2018$result, file =paste0(dirWGCNA_tables, prefixData,"_",prefixRun,"_GOgprofiler2_gerhard2018_mods_full.xlsx"))
```

