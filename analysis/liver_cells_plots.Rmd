title: 'Liver - cell plots'
author: "Jon Thompson, Pers lab, rkm916 at ku dot dk"
date: "`r Sys.time()`" 
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
params: 
  date: !r substr(gsub("-","",as.character(Sys.Date())),3,1000)
  randomSeed: !r 12345
  pValThreshold: !r 0.05
# output:
#   html_notebook:
#     df_print: paged
#     number_sections: yes
#     toc: yes
#     toc_depth: 3
#     toc_float: yes
#   html_document:
#     df_print: paged
#     number_sections: yes
#     toc: yes
#     toc_depth: 3
#     toc_float: yes
---

# Setup

## Load packages

```{r}

library("Seurat")
library("data.table")
library("Matrix")
library("parallel")
library("dplyr")
library("ggplot2")
library("wesanderson")
library("here")


# source utility functions

source(here("perslab-sc-library", "utility_functions.R"))
source(here("perslab-sc-library", "functions_sc.R"))

# Set options

options(stringsAsFactors = F, 
        use="pairwise.complete.obs", 
        warn=1, 
        verbose=F,
        boot.parallel="multicore", # see ?boot: each worker process inherits the environment of the current session, including the workspace and the loaded namespaces and attached packages (but not the random number seed: see below). 
        boot.ncpus = 20,
        mc.cores=40 # for parallel computation
        ) 

# data.table
setDTthreads(threads = NULL, 
             restore_after_fork = NULL)
getDTthreads()

#options(datatable.WhenJisSymbolThenCallingScope=TRUE)

# Set constants

randomSeed = 12345
set.seed(randomSeed)
npcs = 60
# maxit = 100 # for rlm, see users.stat.umn.edu/~sandy/courses/8053/handouts/robust.pdf
flagDate =substr(gsub("-","",as.character(Sys.Date())),3,1000)


# generic project constants 


prefixData = "liver_perslab_int"
prefixRun = "seurat_7"
```

## load data

```{r}
seuratObj <- readRDS(here("output","liver_perslab_int_seurat_7_SCTint_perslab_labels_seuratObj.RDS.gz"))
```

```{r}
dt_mod_embed_gerhard =
```

```{r}
# dt_markers <- openxlsx::read.xlsx(here("output","liver_perslab_align_seurat_7_SCTransformIntegrated_clustermarkers.xlsx"))
# head(dt_markers)
```

```{r}
Seurat::DefaultAssay(seuratObj) <-"SCT_combat"
```

## set cell type colors



```{r}
set.seed(randomSeed+7)

vec_perslab_clust_coarse =unique(seuratObj$cluster_perslab_coarse)
length(vec_perslab_clust_coarse)
# 13

# http://www.sthda.com/english/wiki/colors-in-r
# https://github.com/karthik/wesanderson
vec_colors_cluster_perslab_coarse = c(wes_palette("Darjeeling1"), wes_palette("Darjeeling2")[c(1,2,4)],wes_palette("Chevalier1")[c(1,2,4)], wes_palette("FantasticFox1")[5], wes_palette("Moonrise3")[2]) #RColorBrewer::brewer.pal(name = "Paired", n =12)[3:12]

names(vec_colors_cluster_perslab_coarse) = sample(x=vec_perslab_clust_coarse, size = length(vec_perslab_clust_coarse), replace=F)#[c(1,2,4,5,6,7,8,9,12,13)]
# hand pick additional color
# vec_colors_cluster_perslab_coarse = c(vec_colors_cluster_perslab_coarse, RColorBrewer::brewer.pal(name = "Set3", n =12)[c(1,9,12)])


#names(vec_colors_cluster_perslab_coarse)[11:13] = vec_perslab_clust_coarse[c(3,10,11)]
#sample(x=vec_perslab_clust_coarse,size=length(vec_perslab_clust_coarse), replace = F)

# saveRDS(vec_colors_cluster_perslab_coarse, file =  paste0(dirWGCNA_plots,prefixData,"_", prefixRun,  "_vec_colors_cluster_perslab_coarse.RDS"))
```


## Figure 1

### B. UMAP dataset overview (cluster_perslab_coarse) 

First run PCA and UMAP

```{r}

DefaultAssay(seuratObj) = "integrated"


seuratObj %>% Seurat::RunPCA(object=., npcs=npcs, seed.use=randomSeed) %>% RunUMAP(object=., reduction="pca", seed.use=randomSeed, dims=1:npcs) -> seuratObj

```

```{r}
Idents(seuratObj) <- "cluster_perslab_coarse"
```

```{r}

p <- DimPlot(seuratObj, 
             reduction = "umap",
             group.by="cluster_perslab_coarse", 
             seed=randomSeed, 
             label = T,
             cols= vec_colors_cluster_perslab_coarse,
             label.size = 4.5,
             repel=T)
p <- p + theme(legend.position="none")
p

```

```{r}
saveMeta(savefnc= ggsave, plot= p, filename = here("plots", paste0(prefixData, "_", prefixRun, "_umap_cluster_perslab_coarse_",flagDate,".pdf")), width = 12, height=12)
```

```{r}
# code from: https://github.com/satijalab/seurat/issues/257
pbuild <- ggplot2::ggplot_build(p) # Use ggplot_build to deconstruct the ggplot object
pdata <- pbuild$data[[1]]
vec_colors_full_1 = pdata$colour
names(vec_colors_full_1) = seuratObj$cluster_perslab_coarse
vec_colors_cluster_perslab_coarse = unique(vec_colors_full_1)
names(vec_colors_cluster_perslab_coarse) = unique(names(vec_colors_full_1))
vec_colors_cluster_perslab_coarse
```

```{r}
saveRDS(vec_colors_cluster_perslab_coarse, file =  paste0(dirWGCNA_plots,prefixData,"_", prefixRun,  "_vec_colors_cluster_perslab_coarse.RDS"))
```

also plot cluster_perslab

```{r}
Idents(seuratObj) <- "cluster_perslab"
```

```{r}
p <- DimPlot(seuratObj, 
             reduction = "umap",
             group.by="cluster_perslab", 
             seed=randomSeed, 
             label = T,
             label.size = 4.5,
             repel=T)

p <- p + theme(legend.position="none")

p

saveMeta(savefnc= ggsave, plot= p, filename = here("plots", paste0(prefixData, "_", prefixRun, "_umap_cluster_perslab_",flagDate,".pdf")), width = 12, height=12)
```

save colors

```{r}
# code from: https://github.com/satijalab/seurat/issues/257
pbuild <- ggplot2::ggplot_build(p) # Use ggplot_build to deconstruct the ggplot object
pdata <- pbuild$data[[1]]
vec_colors_full = pdata$colour
names(vec_colors_full) = seuratObj$cluster_perslab
vec_colors_cluster_perslab = unique(vec_colors_full)
names(vec_colors_cluster_perslab) = unique(names(vec_colors_full))
vec_colors_cluster_perslab
```

```{r}
saveRDS(vec_colors_cluster_perslab, file =  paste0(dirWGCNA_plots,prefixData,"_", prefixRun,  "_vec_colors_cluster_perslab.RDS"))
```



<!-- ```{r} -->
<!-- dt_plot = data.table( -->
<!--   cluster_perslab = Idents(seuratObj), -->
<!--   seuratObj@reductions$umap@cell.embeddings) -->
<!-- ``` -->

<!-- ```{r} -->
<!-- max_lim = 11 -->
<!-- ``` -->

<!-- ```{r} -->
<!-- dt_cluster_perslab_mean_coords = dt_plot[,lapply(.SD, mean), by=cluster_perslab, .SDcols=c("UMAP_1","UMAP_2")] -->
<!-- ``` -->

<!-- ```{r} -->
<!-- set.seed(randomSeed) -->

<!-- p <- ggplot(data=dt_plot, mapping=aes(UMAP_1, UMAP_2, color=cluster_perslab)) + -->

<!--       geom_point(size=0.15, alpha=0.7) +  -->

<!--       scale_x_continuous(limits = c(-max_lim, max_lim)) +  -->
<!--       scale_y_continuous(limits=c(-max_lim, max_lim)) + -->

<!--       #scale_color_manual(values=vec_colors_cluster_perslab) +  -->

<!--       ggrepel::geom_text_repel( -->
<!--         direction    = "both", -->
<!--         segment.color = "grey50", -->
<!--         point.padding=0.1, -->
<!--         #label.padding =0.1, -->
<!--         force=0.1, -->
<!--         segment.size = 0.2, -->
<!--         data=dt_cluster_perslab_mean_coords, -->
<!--         mapping = aes( -->
<!--             x=UMAP_1, -->
<!--             y=UMAP_2, -->
<!--             label=stringr::str_wrap(cluster_perslab)), -->
<!--         color="black", -->
<!--         size=4,  -->
<!--         ) +  -->
<!--   theme_minimal() + -->
<!--   # removes all legends  -->
<!--   # https://stackoverflow.com/questions/35618260/remove-legend-ggplot-2-2 -->
<!--   theme(legend.position="none") -->

<!-- p -->

<!-- ``` -->



```{r}
# set.seed(randomSeed)
# 
# vec_cluster_perslab =unique(seuratObj$cluster_perslab)
# length(vec_cluster_perslab)
# # 20
# 
# # we also need a color for gerhard, so 14 in total
# # http://www.sthda.com/english/wiki/colors-in-r
# vec_colors_cluster_perslab = RColorBrewer::brewer.pal(name = "Set1", n =9)
# # hand pick additional colors
# vec_colors_cluster_perslab = c(vec_colors_cluster_perslab, RColorBrewer::brewer.pal(name = "Set3", n =11)) 
# 
# length(vec_colors_cluster_perslab)
# 
# names(vec_colors_cluster_perslab) = vec_cluster_perslab
# 
# # reorder
# vec_colors_cluster_perslab = vec_colors_cluster_perslab[order(as.numeric(gsub("\\D","",names(vec_colors_cluster_perslab))))]
# 
# vec_colors_cluster_perslab = factor(vec_colors_cluster_perslab, ordered=T)

# saveRDS(vec_colors_cluster_perslab, file =  paste0(dirWGCNA_plots,prefixData,"_", prefixRun,  "_vec_colors_cluster_perslab.RDS"))
```


<!-- ```{r} -->
<!-- vec_colors_cluster_perslab_full = pdata$colour  -->

<!-- names(vec_colors_cluster_perslab_full) <- levels(Idents(seuratObj))[match(pdata$group, order(levels(Idents(seuratObj))))] -->

<!-- vec_colors_cluster_perslab <- unique(vec_colors_cluster_perslab_full) -->
<!-- names(vec_colors_cluster_perslab) <- unique(names(vec_colors_cluster_perslab_full)) -->

<!-- vec_colors_cluster_perslab -->
<!-- ``` -->



<!-- get coarse cluster marker genes -->

<!-- ```{r} -->
<!-- clusters = seuratObj@meta.data$cluster_perslab_coarse %>% table %>% names  -->

<!-- Seurat::Idents(seuratObj) <-seuratObj@meta.data$cluster_perslab_coarse -->

<!-- list_iterable = list("X"=clusters) -->
<!-- fun = function(cluster) {tryCatch({ -->
<!--   FindMarkers(seuratObj ,   -->
<!--           #cells.1=colnames(seurat_obj)[Idents(seurat_obj)==cluster], -->
<!--           #cells.2=NULL, -->
<!--           ident.1 = cluster, -->
<!--           only.pos = T, -->
<!--           #ident.2 = clusters[clusters!=cluster], -->
<!--           test.use  ="wilcox", -->
<!--           max.cells.per.ident=1000, -->
<!--           random.seed=randomSeed, -->
<!--           #latent.vars = if (!is.null(merge_specify) | !is.null(merge_group_IDs)) "sample_ID" else NULL, -->
<!--           verbose = T) -->
<!--           },  -->
<!--           error = function(err) { -->
<!--             NA_character_ -->
<!--             warning(paste0("findmarkers failed for ", cluster, " with error ")) -->
<!--           })} -->

<!-- list_markers=NULL -->
<!-- list_markers <- lapply(FUN=fun, "X"=list_iterable[[1]]) -->

<!-- # add the gene and cluster as a column -->
<!-- list_markers <- mapply(function(df_markers, cluster) { -->
<!--   if (!all(sapply(df_markers, is.na))) { -->
<!--     cbind("gene" = rownames(df_markers), "cluster"=rep(cluster, nrow(df_markers)), df_markers) -->
<!--   } else { -->
<!--     NA_character_ -->
<!--   } -->
<!-- }, -->
<!-- df_markers=list_markers,  -->
<!-- cluster=clusters, SIMPLIFY=F) -->

<!-- list_markers <- list_markers[!sapply(list_markers, function(markers) all(is.na(markers)))] -->
<!-- df_markers <- Reduce(x=list_markers, f=rbind) -->
<!-- rownames(df_markers) <- NULL -->

<!-- saveMeta(savefnc=openxlsx::write.xlsx, x = df_markers, file=here("output", paste0(prefixData, "_", prefixRun, "coarse_clustermarkers_", flagDate,".xlsx"))) -->

<!-- ``` -->

<!-- ```{r} -->
<!-- dt_markers = setDT(df_markers) -->
<!-- ``` -->


## plotting

### dot plot

# ```{r}
# 
# list_markers <- lapply(clusters, function(clust){
#   #clust_num <- gsub("-.*","",clust)
#   mycondition = quote(dt_markers$cluster==clust)
#   dt_markers[eval(mycondition),"gene"][1:10]
# })
# names(list_markers) <- clusters
# vec_markers <- unlist(list_markers, use.names = T)
# names(vec_markers) <- gsub("\\.|gene\\d+$","", names(vec_markers))
# head(vec_markers)
# tail(vec_markers)
# ```

```{r}
vec_markers = c("MS4A1","TM4SF4","HMGB2","CD36","HBA1","IGFBP7","AFF3","APOA1","AIF1","KLRF1", "MZB1","IL7R","GNLY")
  
names(vec_markers) = clusters
```

```{r}
factor_cell_clust_group <- factor(clusters, ordered = T)
```

<!-- ```{r} -->
<!-- vec_markers = unique(vec_markers) -->
<!-- ``` -->

```{r,fig.width=18, fig.height=7}

p<-DotPlot_timshel(
  object=seuratObj,
  assay="SCT_combat",
  slot = "data",
  do.scale=T,
  genes.plot=rev(vec_markers),#rev(df$gene_name),
  cols.use = c("blue","white", "red"),#brewer.pal(n=11,"Spectral"),#c("blue","red"),
  col.min = -2.5,
  col.max = 2.5,
  dot.min = 0,
  dot.scale = 6,
  group.by="cluster_perslab_coarse",
  group.order=factor_cell_clust_group,
  plot.legend = T,
  do.return = T,
  x.lab.rot = T,
  coord_flip = F,
  df.marker.panel.to.plot=NULL#df
)
saveMeta(savefnc= ggsave, plot= p, filename = here("plots", paste0(prefixData, "_", prefixRun, "_SCT_combat_clust_coarse_markergene_dotplot",flagDate,".pdf")), width = length(vec_markers)/2.5, height=length(unique(names(vec_markers)))/3.5)
```


### barplot showing distribution of clusters per patient

proportion of condition & hashtag combination within each biological cluster

```{r, include=F}
dt = data.table("cluster" = seuratObj$cluster_perslab_coarse,
                "donor"= as.character(seuratObj$sample_ID))

#dt[,cluster:=factor(cluster, levels = 0:max(cluster), ordered = T)]
dt[,n_donor := paste0(donor," (",.N, " cells)"), by=donor]
vec_factorLevels <- dt$n_donor[gsub("\\ .*","",dt$n_donor) %>% as.numeric %>% order] %>% unique
dt[,n_donor := factor(n_donor, levels = vec_factorLevels, ordered=T),]
dt_sum <- dt[,.N, by=.(n_donor,cluster)]
```

```{r, echo=F, fig.width=12}

p <- ggplot(dt_sum,aes(x = n_donor, y=N, fill = factor(cluster))) + 
  geom_bar(position="fill", stat="identity") + 
  scale_y_continuous(labels = scales::percent) +
  scale_fill_manual(values=vec_colors_cluster_perslab_coarse) +
  theme(axis.text.x = element_text(angle = 90)) +
  labs(x="donor", y="n cells", fill = "cluster")
  

saveMeta(savefnc= ggsave, plot= p, filename = here("plots", paste0(prefixData, "_", prefixRun, "_SCT_combat_barplot_donor_cluster_pct_",flagDate,".pdf")), width = 8, height=7)
```


### feature plots

```{r}
genes = c("TREM2")
```

```{r,fig.width=10}
Seurat::FeaturePlot(object=seuratObj, features="TREM2")
```

```{r}
vec_mods = c("aquamarine", "brown", "mediumaquamarine")
```

```{r}
DefaultAssay(object = seuratObj) = "integrated"
```

```{r}
p <- Seurat::FeaturePlot(object=seuratObj, features=vec_mods, blend = F, order = T)
saveMeta(savefnc= ggsave, plot= p, filename = here("plots", paste0(prefixData, "_", prefixRun, "_", prefixOut, "_mod_featplots_",flagDate,".pdf")), width = 12, height=12)
```

### violin plots

```{r}
vec_genes = c("VCAN")
```

```{r}
DefaultAssay(seuratObj) = "SCT_combat"
```

```{r}
#list_seuratObj[[1]]$macs_subclust <- factor(list_seuratObj[[1]]$macs_subclust, levels = 0:6, ordered=T)
for (gene in vec_genes) {
  p <- Seurat::VlnPlot(object = seuratObj, 
                       features = vec_genes,
                       assay = "SCT_combat", 
                       slot = "data", 
                       log=FALSE,
                       sort = F, 
                       group.by = "cluster_perslab")
  
  ggsave(plot = p, filename = here("plots", paste0(prefixData, "_",prefixRun, "_",gene,"_vlnplot_", params$date, ".pdf")), width = 12, height=9)
}
```

## bar plot

sc wgcna modules

```{r}

dt_geneMod_perslab_merged$module_pres %>% unique -> vec_mods_perslab

vec_mods_perslab<- vec_mods_perslab[!is.na(vec_mods_perslab) & nchar(vec_mods_perslab)>0]

mat_embed_perslab <- sapply(vec_mods_perslab, function(mod) {

  # get gene weights
  condition = quote(dt_geneMod_perslab_merged[[colModule]]==mod)
  vec_pkMs <- dt_geneMod_perslab_merged[eval(condition), pkMs,]

  # normalize module gene weights to sum to 1
  vec_pkMs <- vec_pkMs/sum(vec_pkMs)

  # find corresponding rows of the expression matrix
  vec_idxRow <- match(dt_geneMod_perslab_merged[eval(condition), ..colGeneNames, ][[1]], dt_datExpr[,gene])

  # filter out mis-matches
  vec_pkMs <- vec_pkMs[!is.na(vec_idxRow)]
  vec_idxRow <- vec_idxRow[!is.na(vec_idxRow)]

  # compute weighted sum of normalized expression
  dt_datExpr[vec_idxRow,-("gene")] %>% as.matrix -> mat_sub

  vec_pkMs %*% mat_sub

})

rownames(mat_embed_perslab) <- colnames(dt_datExpr)[-1]

mat_embed_perslab[0:4,0:4]
```
