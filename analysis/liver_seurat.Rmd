  ---
title: 'Liver project Seurat processing'
author: "Jon Thompson, Pers lab"
date: "`r Sys.time()`" 
params:
  flag
output:
  html_notebook: 
    df_print: paged
    number_sections: yes
    toc: yes
    toc_depth: 3
    toc_float: yes
---

Tutorial: https://satijalab.org/seurat/mca.html

# Setup 

## Load packages

```{r}

suppressPackageStartupMessages(library(Seurat))
suppressPackageStartupMessages(library(dplyr))
suppressPackageStartupMessages(library(Matrix))
suppressPackageStartupMessages(library(parallel))
suppressPackageStartupMessages(library(readxl))
```

## Source functions and set session parameters and constants

```{r}

source("/projects/jonatan/functions-src/functions_v2.2_dev1.R")

options(stringsAsFactors = F)

dir_project = "/projects/jonatan/tmp-liver/"
dir_RObjects = paste0(dir_project, "/RObjects/")
dir_plots = paste0(dir_project, "/plots/")
dir_log = paste0(dir_project, "/log/")
dir_tables = paste0(dir_project, "/tables/")

n_cores = 10

```

# Analysis

## Data ingestion and pre-processing 

### Load expression and meta-data into top-level environment

```{r}

mca.matrix <- readRDS(file = "/projects/rikard/Liver/Microwell_seq/MCA/MCA_merged_mat.rds")

mca.metadata <- read.csv("/projects/rikard/Liver/Microwell_seq/MCA/MCA_All-batch-removed-assignments.csv", row.names = 1, quote = "", header=T)

perslab.mat <- 
```

### Create Seurat Object

```{r}
mca <- CreateSeuratObject(raw.data = mca.matrix, meta.data = mca.metadata, project = "MouseCellAtlas")
# Only keep annotated cells
mca <- SubsetData(mca, cells.use = rownames(mca@meta.data[!is.na(mca@meta.data$ClusterID), 
    ]), do.clean = TRUE)
# Leaves us with 242k cells
mca
```

### QC

```{r}
mca <- NormalizeData(object = mca, normalization.method = "LogNormalize", scale.factor = 10000)
```

###

```{r}
mca_liver <- SubsetData(object = mca, cells.use = rownames(mca@meta.data)[mca@meta.data$Tissue=="Liver"], do.clean = T) 
```

```{r}
saveRDS(mca_liver, file="/projects/jonatan/tmp-liver/RObjects/mca_liver.rds")
```

```{r}
#load seurat object..
```

```{r}
library(gridExtra)
```

```{r}

cellMarkers <- list("Hepatocytes"=c("ALB","HAMP","ARG1","PCK1","AFP","BCHE"),
                      "LSECs"=c("CALCRL","CD32B","VWF"),
                      "Cholangiocytes"=c("KRT19","EPCAM","FXDY2","CLDN4","CLDN10",
                                       "SOX9","MMP7","CXCL1","CFTR","TFF2","KRT7","CD24"),
                      "Hepatic Stellate Cells"=c("ACTA2","COL1A1","TAGLN","COL1A2",
                                                 "COL3A1","SPARC","RBP1","DCN","MYL9"),
                      "Macrophages"=c("CD68","MARCO"),
                      "ab T cells"=c("CD2","CD3D","TRAC","IL32","CD3E"),
                      "gd T cells"=c("NKG7","FCGR3A","HOPX","GNLY"),
                      "T cells"= c("CD4","CD8"),
                      "NK cells"=c("GZMK","KLRF1","CCL3","CMC1"),
                      "Plasma cells"=c("CD27","IGHG1"),
                      "Mature B cells"=c("MS4A1","LTB","CD52","IGHD"),
                      "Erythroid cells"=c("HBB","SLC25A37","CA1","ALAS2"))

for (cellType in names(cellMarkers)) {
  list_plots <- lapply(cellMarkers[[cellType]], function(markerGene) {
    try({
      FeaturePlot(object = seurat_obj, features.plot = markerGene,reduction.use = "tsne", no.legend = F,cols.use = c("grey92", "blue"))
      ggsave(filename = paste0(dir_plots, prefix_test, "_", prefix_run, "_",cellType, "_", markerGene,"_markers_feautureplot_.pdf"), width = 15, height=12)
      })
    })
  #grid.arrange(list_plots, nrow=1, ncol=length(list_plots))
  
}

```

```{r}
for (cellType in names(cellMarkers)) {
  #par(mfrow=c(1,length(cellMarkers[[cellType]])))
   lapply(cellMarkers[[cellType]], function(markerGene) {
    try({
      pdf(file = paste0(dir_plots, prefix_test, "_", prefix_run, "_",cellType,"_",markerGene,"_histogram_.pdf"), width = 15, height=12)
      plot(density(x = seurat_obj@raw.data[markerGene,]))
      dev.off()
      })
    }) #grid.arrange(list_plots, nrow=1, ncol=length(list_plots))
}
```

```{r}
out<- sapply(cellMarkers, function(x) sapply(x, function(y) try(summary(seurat_obj@raw.data[y,]))))
```

```{r}
cellMarkers_select <- list("LSECs"=c("CALCRL"),
                      "Cholangiocytes"=c("TFF2","CD24"),
                      "Hepatic Stellate Cells"=c("ACTA2"),
                      "Macrophages"=c("CD68"),
                      "ab T cells"=c("IL32"),
                      "gd T cells"=c("NKG7","GNLY"),
                      "T cells"= c("CD4"),
                      "NK cells"=c("CCL3"),
                      "Plasma cells"=c("IGHG1"),
                      "Mature B cells"=c("CD52"),
                      "Erythroid cells"=c("HBB"))
```

```{r}

for (cellType in names(cellMarkers_select)) {
  list_plots <- lapply(cellMarkers_select[[cellType]], function(markerGene) {
    try({
      FeaturePlot(object = seurat_obj, features.plot = markerGene,reduction.use = "tsne", no.legend = F,cols.use = c("grey92", "blue"))
      ggsave(filename = paste0(dir_plots, prefix_test, "_", prefix_run, "_",cellType, "_", markerGene,"_markers_select_feautureplot_.pdf"), width = 15, height=12)
      })
    })
  #grid.arrange(list_plots, nrow=1, ncol=length(list_plots))
  
}
```

```{r}
# MarParland et al cell cluster annotation
cluster_annot_ref <- list("1"="Hep_1","2"="Alpha_Beta_T_cells", "3"="Hep_2", "4"="Inflammatory_Macs", "5"="Hep_3","6"="Hep_4","7"="Plasma_cells","8"="NK_like_cells","9"="Gamma_delta_T_cells_1","10"="Non_inflammatory_Macs","11"="Periportal_LSECs","12"="Central_venous_LSECs","13"="Portal_endothelial_cells","14"="Hep_5","15"="Hep_6","16"="Mature_B_cells","17"="Cholangiocytes","18"="Gamma_delta_T_cells_2","19"="Erythroid_cells","20"="Hepatic_stellate_cells")
```

```{r}
Cluster_annot <- seu$Cluster
for (clust in unique(seu$Cluster)){
  Cluster_annot[Cluster_annot==clust] <- cluster_annot_ref[[clust]]
}
seu$Cluster_annot <- Cluster_annot
```

### 2019-01-03 rename genes that are causing FindIntegrationAnchors to crash
FindIntegrationAnchors failed again with error Error in data.frame(row.names = rownames(x = data)): duplicate row.names: RP11-442N24--B.1, RP11-59D5--B.2, RP11-544L8--B.4, XXyac-YX65C7-A.2, RP11-1157N2--B.2
, returning NULL
Warning messages:
1: In CreateAssayObject(counts = merged.counts, min.cells = -1, min.features = -1) :
  Feature names cannot have underscores ('_'), replacing with dashes ('-')
2: In CreateAssayObject(counts = merged.counts, min.cells = -1, min.features = -1) :
  Feature names cannot have underscores ('_'), replacing with dashes ('-')

```{r}
MacParland_raw <- read.csv("/projects/jonatan/tmp-liver/data/GSE115469_Data.csv", header=T,quote = "")
MacParland_raw[0:3,0:3]

```

```{r}
rownames(MacParland_raw) <- MacParland_raw$X..
MacParland_raw$X.. <- NULL
```

```{r}
rownames_tmp<-sapply(rownames(MacParland_raw), function(name) {
  name <- gsub("\\.", "-", name)
  name <- gsub("[^a-z|0-9|-]", "", name, ignore.case = T)
  name
})
head(rownames_tmp)
```

```{r}
rownames_tmp %>% duplicated %>% sum
```

```{r}
rownames(MacParland_raw) <- rownames_tmp
```

```{r}
colnames_tmp <- gsub("^X|\\.", "", colnames(MacParland_raw))
```

```{r}
colnames(MacParland_raw) <- colnames_tmp
```


```{r}
write_csv(x=MacParland_raw, path = "/projects/jonatan/tmp-liver/data/GSE115469_Data.csv")
```

[...]

### After making seurat objects, add metadata and filter them
```{r}
list_seurat_obj_tmp <- lapply(list_seurat_obj, function(data_tmp) {
  
  # Compute and add percent mito and percent ribo as metadata
  mito.genes <- grepl(pattern = "^mt-", x = rownames(data_tmp), ignore.case=T)
  ribo.genes <- grepl(pattern = "^Rp[sl][[:digit:]]", x = rownames(data_tmp), ignore.case=T)
  colSums_tmp <- colSums(x = data_tmp)
  data_tmp$percent.mito = colSums(x = data_tmp[mito.genes,])/colSums_tmp
  data_tmp$percent.ribo = colSums(x = data_tmp[ribo.genes,])/colSums_tmp
  data_tmp
})

list_seurat_obj_tmp <- lapply(list_seurat_obj_tmp, function(data_tmp) {

  subset(x = data_tmp, subset = nCount_RNA >= nUMI_min & 
                       nCount_RNA <= nUMI_max &
                       nFeature_RNA >= nGene_min &
                       nFeature_RNA <= nGene_max &
                       percent.mito <= percent.mito_max & 
                       percent.ribo <= percent.ribo_max)

})
```

#### add patient metadata 

load data

```{r}
df_metadataMacparland <- read.csv("/projects/jonatan/tmp-liver/data/macParland_patient_metadata.csv", quote="", header = T)
metadataPerslab <- read_xlsx("/projects/jonatan/tmp-liver/data/Liver_meta_data.xlsx", na="", col_names=T)
df_metadataPerslab <- as.data.frame(metadataPerslab)
seuratObj <- readRDS("/projects/jonatan/tmp-liver/RObjects/liver_perslab_macparland_align_seurat_4_all_seurat_obj.RDS.gz")
```

```{r}
head(df_metadataMacparland)
```

align the data categories

```{r}

df_metadataMacparland[["Sex"]] <- ifelse(df_metadataMacparland[["Sex"]]=="M",yes=1,no=2)
colnames(df_metadataMacparland)[3] <- "Ethnicity"
df_metadataMacparland[["BMI_over_35"]] <- c(0,0,1,0,0)
df_metadataMacparland[["BMI_over_50"]] <- c(0,0,0,0,0)
df_metadataMacparland[["Alcohol_use"]] <- c(7,NA,2,8,NA)
df_metadataMacparland[["NASH"]] <- c(NA,0,NA,0,0) 
df_metadataMacparland[["ID"]] <- rownames(df_metadataMacparland)

df_metadataPerslab[["Ethnicity"]] <- "Danish"
df_metadataPerslab[["BMI"]] <- df_metadataPerslab[["BMI_baseline_calculated"]] 
df_metadataPerslab[["Smoking"]] <- df_metadataPerslab[["Smoking_status_baseline"]]
df_metadataPerslab[["Alcohol_use"]] <- df_metadataPerslab[["Alcoholintake_current"]]
df_metadataPerslab[["NASH"]] <- ifelse(df_metadataPerslab[["NASH_according_to_FLIP"]]==1,1,0)
df_metadataPerslab[["NASH"]][df_metadataPerslab[["NASH_according_to_FLIP"]]==3] <- 0.5 # transform NASH into more meaningful
colnames(df_metadataPerslab)[2] <- "Age"
```

```{r}
colsToInclude <- c("ID", "Age", "Sex", "Ethnicity", "BMI", "Smoking", "Alcohol_use",  "NASH")
df_metadataCombined <- rbind(df_metadataMacparland[,match(colsToInclude, colnames(df_metadataMacparland))], df_metadataPerslab[,match(colsToInclude,colnames(df_metadataPerslab))])
df_metadataCombined[["ID"]][1:5] <- paste0("P",df_metadataCombined[["ID"]][1:5],"TLH") 
df_metadataCombined[["ID"]][6:15] <- paste0(df_metadataCombined[["ID"]][6:15],"L") 
```

```{r}
write.csv(df_metadataCombined, file="/projects/jonatan/tmp-liver/data/metadataCombined.csv", row.names=F, quote=F)
```

