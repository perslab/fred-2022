---
title: 'Muscle C2 sample QC and SC-Transform normalization'
author: "Jon Thompson, Pers lab, rkm916 at ku dot dk"
date: "`r Sys.time()`" 
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
params: 
  date: !r substr(gsub("-","",as.character(Sys.Date())),3,1000)
  randomSeed: !r 12345
  pValThreshold: !r 0.05
# output:
#   html_notebook:
#     df_print: paged
#     number_sections: yes
#     toc: yes
#     toc_depth: 3
#     toc_float: yes
#   html_document:
#     df_print: paged
#     number_sections: yes
#     toc: yes
#     toc_depth: 3
#     toc_float: yes
---

# Setup

## Set options

```{r}
options(stringsAsFactors = F,
        use="pairwise.complete.obs",
        warn=1,
        verbose=F,
        mc.cores=40# for parallel computation
        )
```

## source utility functions

```{r}
source("./perslab-sc-library/utility_functions.R")
source("./perslab-sc-library/functions_sc.R")
```

## Load packages

```{r}
#devtools::install_github(repo = "satijalab/seurat", ref = "develop") # dev version of Seurat

library(data.table)
library(Seurat)
library(ggplot2)
library(Matrix)
library(parallel)
library(tidyr)
library(here)
library(openxlsx)
#ipak(c("Seurat", "dplyr", "ggplot2", "Matrix", "parallel", "readr", "tidyr",  "AUCell", "Oscope", "openxlsx", "here"))
```

## Set constants

```{r}
randomSeed = 12345
set.seed(randomSeed)

pValThreshold = 0.05
pval.adjust.method = "BH"
```


generic project constants 

```{r}
prefixData = "muscle_C2"
prefixRun = "run1"
```

## specific options and params

```{r}
options(future.globals.maxSize = 8000 * 1024^2)
nCores=  20
npcs=60
res_primary=0.8
```

## load data

```{r}
path_data <- "/data/sc-10x/data-runs/180511-perslab-immunometab/C2-5000_cells/outs/filtered_feature_bc_matrix"
data <- Seurat::Read10X(data.dir=path_data)
```

```{r}
seuratObj <- CreateSeuratObject(counts = data, project = prefixData, assay = "RNA")
```

# Analysis 

## QC

### find percent mitochrondria

```{r}
seuratObj <- PercentageFeatureSet(seuratObj, pattern = "^MT-", col.name = "percent.mt")
```

### Cell-cycle analysis

See https://satijalab.org/seurat/cell_cycle_vignette.html

```{r}
# list_cellCycleGenes <- lapply(paths_cellCycleGenes, function(x) load_obj(x)[,1])
# names(list_cellCycleGenes) <- names(paths_cellCycleGenes)

# A list of cell cycle markers, from Tirosh et al, 2015, is loaded with Seurat.  We can
# segregate this list into markers of G2/M phase and markers of S phase 
list_cellCycleGenes <- list()
list_cellCycleGenes[["s.genes"]] <- cc.genes$s.genes
list_cellCycleGenes[["g2m.genes"]] <- cc.genes$g2m.genes
```

Compute cell cycle scores using provided genesets

```{r}

seuratObj <- Seurat::CellCycleScoring(object = seuratObj, 
                               s.features = if (!is.null(list_cellCycleGenes[["s.genes"]])) list_cellCycleGenes[["s.genes"]] else NULL, 
                               g2m.features = if (!is.null(list_cellCycleGenes[["g2m.genes"]])) list_cellCycleGenes[["g2m.genes"]] else NULL, 
                              set.ident = F)

seuratObj$CC.Difference <- seuratObj$S.Score - seuratObj$G2M.Score
```

### Normalize data and regress out confounders

```{r}
seuratObj <- Seurat::SCTransform(seuratObj,
                              vars.to.regress = c("percent.mt",  "CC.Difference"), #  Variables to regress out in a second non-regularized linear regression. For example, percent.mt. Default is NULL
                              do.correct.umi=T,
                              do.scale=F,
                              do.center=T,
                              return.only.var.genes =F,
                              seed.use = randomSeed,#params$randomSeed,
                              verbose=T)
```

### From here on standard clustering workflow 

```{r}
seuratObj <- RunPCA(seuratObj, assay="SCT", npcs = npcs, seed.use = randomSeed)
```

```{r}
seuratObj <- FindNeighbors(object = seuratObj, dims= 1:npcs, verbose = T)
seuratObj <- FindClusters(object = seuratObj, verbose = T,resolution =res_primary, random.seed = randomSeed)
```

```{r}
clusters = seuratObj@meta.data[[paste0("SCT_snn_res.", res_primary)]] %>% table %>% names 
Idents(seuratObj) <-seuratObj@meta.data[[paste0("SCT_snn_res.", res_primary)]]

list_iterable = list("X"=clusters)
fun = function(cluster) {tryCatch({
  FindMarkers(seuratObj ,  
              #cells.1=colnames(seurat_obj)[Idents(seurat_obj)==cluster],
              #cells.2=NULL,
              ident.1 = cluster,
              only.pos = T,
              #ident.2 = clusters[clusters!=cluster],
              test.use  ="MAST",
              max.cells.per.ident=1000,
              random.seed=randomSeed,
              #latent.vars = if (!is.null(merge_specify) | !is.null(merge_group_IDs)) "sample_ID" else NULL,
              verbose = T)
}, 
error = function(err) {
  NA_character_
})}
list_markers=NULL
list_markers <- lapply(FUN=fun, "X"=list_iterable[[1]])

# add the gene and cluster as a column
list_markers <- mapply(function(df_markers, cluster) {
  if (!all(sapply(df_markers, is.na))) {
    cbind("gene" = rownames(df_markers), "cluster"=rep(cluster, nrow(df_markers)), df_markers)
  } else {
    NA_character_
  }
},
df_markers=list_markers, 
cluster=names(table(Idents(seuratObj))), SIMPLIFY=F)

list_markers <- list_markers[!sapply(list_markers, function(markers) all(is.na(markers)))]
df_markers <- Reduce(x=list_markers, f=rbind)
rownames(df_markers) <- NULL
dt_markers <- setDT(df_markers); rm(df_markers)

```

```{r}
saveMeta(savefnc=openxlsx::write.xlsx, x = dt_markers, file=here("output", paste0(prefixData, "_", prefixRun, "_clustermarkers.xlsx")))
```

## Run UMAP for visualization

```{r}
seuratObj <- RunUMAP(object=seuratObj, dims=1:npcs, reduction = "pca", assay= "SCT", seed.use = randomSeed)
```

```{r}

p1 <-DimPlot(seuratObj,  
             assay="SCT",
             reduction = 'umap', 
             group.by = paste0("SCT_snn_res.", res_primary),
             label = FALSE)

saveMeta(savefnc= ggsave, plot= p1, filename = here("plots", paste0(prefixData, "_", prefixRun, "_", "_UMAP_SCT_FindClusters.pdf")), width = 20, height=12)

```

save seurat object

```{r}
saveMeta(savefnc = saveRDS, object =seuratObj, file = here("output", paste0(prefixData, "_", prefixRun, "_seuratObj.RDS.gz")), compress="gzip")
```




