---
title: 'Liver - filter gene modules on various QC metrics'
author: "Jon Thompson, Pers lab, rkm916 at ku dot dk"
date: "`r Sys.time()`" 
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
params: 
  date: !r substr(gsub("-","",as.character(Sys.Date())),3,1000)
  randomSeed: !r 12345
  pValThreshold: !r 0.05
# output:
#   html_notebook:
#     df_print: paged
#     number_sections: yes
#     toc: yes
#     toc_depth: 3
#     toc_float: yes
#   html_document:
#     df_print: paged
#     number_sections: yes
#     toc: yes
#     toc_depth: 3
#     toc_float: yes
---

previous: liver_module_embed_in_sc.Rmd

# Setup

## Set options


```{r}
options(stringsAsFactors = F, 
        use="pairwise.complete.obs", 
        warn=1, 
        verbose=F,
        mc.cores=10 # for parallel computation
        ) 

RNGkind("L'Ecuyer-CMRG")

R=1e4-1

randomSeed = 12345
set.seed(randomSeed)

pAdjMethod = "BH"
pValThreshold = 0.05 #params$pValThreshold

flagDate = substr(gsub("-","",as.character(Sys.Date())),3,1000)

# Load packages


library("data.table")
library("dplyr")
library("Matrix")
library("parallel")
library("here")
#library("broom")
#library("WGCNA")
#library("liger")
#library("boot")
library("Seurat")#,lib.loc ="/tools/R/envs/rkm916/x86_64-redhat-linux-gnu-library/4.0/")
#library("biomaRt")
library("presto")
library("pheatmap")

# source utility functions

source(here("perslab-sc-library", "utility_functions.R"))
source(here("perslab-sc-library", "functions_sc.R"))

# Set constants

# generic project constants 

#prefixData <- "aizarani"
prefixData = "liver_perslab_int"
prefixRun = "seurat_7"
prefixRunWGCNA = "wgcna3"
prefixOut <- "SCTint"

dirWGCNA_outs = "/projects/jonatan/pub-perslab/18-liver-wgcna/"
dirWGCNA_plots = paste0(dirWGCNA_outs, "plots/" )
dirWGCNA_RObjects = paste0(dirWGCNA_outs, "RObjects/" )
dirWGCNA_tables = paste0(dirWGCNA_outs, "tables/" )

colModule = "module"
colCellClust = "cell_cluster"
```

we are interested in a subset of the "cluster_perslab_coarse" cell types

```{r}
vec_celltypesOfInterest <- c("T-cells-alpha-beta",
                             "NK-like-cells",
                             "Endothelial-cells",
                             "T-cells-gamma-delta", 
                             "Macrophages",  
                             "Cholangiocytes",        
                             "Hepatocytes",
                             "Hepatic-stellate-cells", 
                             "Dendritic-cells", 
                             "Hepatic-stem-cells",
                             "B-cells-mature",
                             "Plasma-cells")
```

## load data

load WGCNA gene module tables

perslab 

```{r}
path_geneMod_perslab <- paste0(dirWGCNA_tables,"liver_perslab_int_", prefixRunWGCNA,"_geneMod.csv.gz")
dt_geneMod_perslab <-fread(file=path_geneMod_perslab )
dt_geneMod_perslab[0:3,]
#                data    run   cell_cluster     module    genes        pkMs
# 1: liver_perslab_int wgcna3 B-cells-mature lightblue3 KIAA1551 0.009426350
# 2: liver_perslab_int wgcna3 B-cells-mature lightblue3     ZEB1 0.008230427
# 3: liver_perslab_int wgcna3 B-cells-mature lightblue3    XYLT1 0.008185864
```

gerhard 2018

```{r}
path_geneMod_gerhard2018 <- paste0(dirWGCNA_tables,"liver_gerhard2018_", "wgcna3","_geneMod.csv.gz")
dt_geneMod_gerhard2018 <-fread(file=path_geneMod_gerhard2018)
dt_geneMod_gerhard2018[0:3,]
#             data    run cell_cluster       module           genes       pkMs
# 1: liver_gerhard2018 wgcna1  gerhard2018 midnightblue ENSG00000171848 0.03919702
# 2: liver_gerhard2018 wgcna1  gerhard2018 midnightblue ENSG00000066279 0.03745749
# 3: liver_gerhard2018 wgcna1  gerhard2018 midnightblue ENSG00000131747 0.03606625
```

<!-- moylan 2013 -->

<!-- ```{r} -->
<!-- path_geneMod_moylan2013 <- paste0(dirWGCNA_tables,"liver_moylan2013_", "wgcna1","_geneMod.csv.gz") -->
<!-- dt_geneMod_moylan2013 <-fread(file=path_geneMod_moylan2013) -->
<!-- dt_geneMod_moylan2013[0:3,] -->

<!-- #                data    run cell_cluster               module   genes      pkMs -->
<!-- # 1: liver_moylan2013 wgcna1   moylan2013 lightgoldenrodyellow    ANO2 0.2370768 -->
<!-- # 2: liver_moylan2013 wgcna1   moylan2013 lightgoldenrodyellow CNTNAP5 0.2365604 -->
<!-- # 3: liver_moylan2013 wgcna1   moylan2013 lightgoldenrodyellow  TEDDM1 0.2353492 -->

<!-- ``` -->

Seurat object containing module embeddings in single cell

```{r}
path_seuratObj <- here("output", paste0(prefixData, "_", prefixRun, "_", prefixOut, "_seuratObj.RDS"))

seuratObj_sub <- readRDS(path_seuratObj)
```

```{r}
mat_embed = seuratObj@meta.data[,c(unique(dt_geneMod_perslab$module), unique(dt_geneMod_gerhard2018$module))]
```


Load DE genes

<!-- load perslab cell metadata  -->

<!-- ```{r} -->
<!-- dt_meta <- fread(here("data", paste0(prefixData, "_", prefixRun, "_metadata_full.csv.gz"))) -->
<!-- dt_meta[0:3,0:5] -->
<!-- ``` -->

<!-- load Moylan 2013 bulk data -->

<!-- ```{r} -->
<!-- dt_datExpr_moylan <- fread(here("data", "moylan2013.norm.expr.qc.csv.gz")) -->
<!-- ``` -->

# Analysis / filtering 

<!-- first map dt_geneMod genes to ensembl / hgnc -->

<!-- using biomart -->
<!-- https://www.bioconductor.org/packages/devel/bioc/vignettes/biomaRt/inst/doc/biomaRt.html -->

<!-- ```{r} -->
<!-- ensembl = useMart("ensembl",dataset="hsapiens_gene_ensembl") -->
<!-- ``` -->

<!-- ```{r} -->
<!-- grep("hgnc", listAttributes(ensembl)$name, value=T) -->
<!-- #[1] "hgnc_id"         "hgnc_symbol"     "hgnc_trans_name" -->
<!-- ``` -->

<!-- ```{r} -->
<!-- dt_mapping_biomart <- biomaRt::getBM(attributes = c('hgnc_symbol','ensembl_gene_id'), -->
<!--                              filters = 'hgnc_symbol',  -->
<!--                              values = dt_geneMod_perslab$genes,  -->
<!--                              mart = ensembl) -->
<!-- dt_mapping_biomart <- setDT(dt_mapping_biomart) -->
<!-- ``` -->

<!-- ```{r} -->
<!-- dt_mapping_perslab <- fread("/projects/jonatan/data/gene_remap/gene_annotation_hsapiens.txt.gz") -->
<!-- ``` -->

<!-- ```{r} -->
<!-- dt_geneMod_perslab$ensembl_perslab <- gene_map(dataIn = dt_geneMod_perslab$genes,  -->
<!--                                df_mapping = dt_mapping_perslab, -->
<!--                                from = "hgnc_symbol",  -->
<!--                                to = "ensembl_gene_id",  -->
<!--                                na.rm = F) -->
<!-- ``` -->

<!-- ```{r} -->
<!-- dt_geneMod_perslab$ensembl_biomart <- gene_map(dataIn = dt_geneMod_perslab$genes,  -->
<!--                                df_mapping = dt_mapping_biomart, -->
<!--                                from = "hgnc_symbol",  -->
<!--                                to = "ensembl_gene_id",  -->
<!--                                na.rm = F) -->
<!-- ``` -->

<!-- ```{r} -->
<!-- dt_geneMod_moylan2013$ensembl <- gene_map(dataIn = dt_geneMod_moylan2013$genes,  -->
<!--                                df_mapping = dt_mapping_perslab, -->
<!--                                from = "hgnc_symbol",  -->
<!--                                to = "ensembl_gene_id",  -->
<!--                                na.rm = F) -->
<!-- ``` -->

<!-- ```{r} -->
<!-- colnames(dt_geneMod_gerhard2018)[which(colnames(dt_geneMod_gerhard2018)=="genes")] <- "ensembl" -->
<!-- ``` -->

<!-- ```{r} -->
<!-- dt_geneMod_gerhard2018$genes_perslab <- gene_map(dataIn = dt_geneMod_gerhard2018$ensembl,  -->
<!--                                df_mapping = dt_mapping_perslab, -->
<!--                                from = "ensembl_gene_id",  -->
<!--                                to = "hgnc_symbol",  -->
<!--                                na.rm = F) -->
<!-- ``` -->

<!-- ```{r} -->
<!-- dt_geneMod_gerhard2018$genes_biomart <- gene_map(dataIn = dt_geneMod_gerhard2018$ensembl,  -->
<!--                                df_mapping = dt_mapping_biomart, -->
<!--                                from = "ensembl_gene_id",  -->
<!--                                to = "hgnc_symbol",  -->
<!--                                na.rm = F) -->
<!-- ``` -->

add new filter columns to dt_geneMod to retain cell clusters of interest

```{r}
dt_geneMod_perslab[,cell_cluster_filter:=ifelse(cell_cluster %in% ..vec_celltypesOfInterest,cell_cluster,NA),]
dt_geneMod_perslab[,module_filter:=ifelse(cell_cluster %in% ..vec_celltypesOfInterest,paste0("perslab_",module),NA),]
```

```{r}
dt_geneMod_gerhard2018[,cell_cluster_filter:=cell_cluster]
dt_geneMod_gerhard2018[,module_filter:=paste0("gerhard2018_",module)]
```

<!-- ```{r} -->
<!-- dt_geneMod_moylan2013[,cell_cluster_filter:=cell_cluster] -->
<!-- dt_geneMod_moylan2013[,module_filter:=paste0("moylan2013_", module)] -->
<!-- ``` -->


## check how modules correlate with covariates

```{r}
vec_covar_cell = c("nCount_RNA", "nFeature_RNA", "percent.mito", "percent.ribo", "CC.Difference", "cluster_perslab", "cluster_perslab_coarse")

vec_covar_donor = c("sample_ID", "nas_sum","fibrosis_grade", "lobular_inflammation_grade", "Sex", "Age", "BMI", "Smoking", "Alcohol_use")
```

prep dataframes with dummy variables for factors

```{r}
df_covar_cell = seuratObj@meta.data[, vec_covar_cell]
## check how metamodules correlate with covariates
```


```{r}
vec_covar_cell = c("nCount_RNA", "nFeature_RNA", "percent.mito", "percent.ribo", "CC.Difference", "cluster_perslab", "cluster_perslab_coarse")

vec_covar_donor = c("sample_ID", "nas_sum","fibrosis_grade", "lobular_inflammation_grade", "Sex", "Age", "BMI", "Smoking", "Alcohol_use")
```

prep dataframes with dummy variables for factors

```{r}
df_covar_cell = seuratObj@meta.data[, vec_covar_cell]
# df_covar_cell$cluster_perslab <- factor(df_covar_cell$cluster_perslab)
# df_covar_cell$cluster_perslab_coarse <- factor(df_covar_cell$cluster_perslab_coarse)

mat_model_covar_cell = model.matrix(data = df_covar_cell, object=~  cluster_perslab-1 + cluster_perslab_coarse-1)

df_covar_cell$cluster_perslab <- df_covar_cell$cluster_perslab_coarse <- NULL
df_covar_cell <- data.frame(df_covar_cell, mat_model_covar_cell)
```

```{r}
df_covar_donor = seuratObj@meta.data[,vec_covar_donor]
vec_covar_donor_numeric = c("nas_sum", "fibrosis_grade", "lobular_inflammation_grade", "Age", "BMI", "Smoking", "Alcohol_use")
#vec_covar_factor = c("sample_ID", "Sex", "Smoking",  "Ethnicity", "Alcohol_use") 
df_covar_donor[, vec_covar_donor_numeric] <- apply(df_covar_donor[, vec_covar_donor_numeric], 2, as.numeric)
#df_covar_donor[, vec_covar_factor] <- apply(df_covar_donor[, vec_covar_factor], 2, factor)

mat_model_covar_donor = model.matrix(data = df_covar_donor, object=~  sample_ID-1 + Sex-1)

df_covar_donor$sample_ID <- df_covar_donor$Sex <- NULL
df_covar_donor <- data.frame(df_covar_donor, mat_model_covar_donor)
```

## compute correlations between module embeddings and covariates, but using only the cells in which the module was detected

<!-- ```{r} -->
<!-- list_mat_embed_cluster_perslab_coarse = lapply(unique(seuratObj$cluster_perslab_coarse), function(cell_clust) { -->

<!-- }) -->

<!-- names(list_mat_embed_cluster_perslab_coarse) = unique(seuratObj$cluster_perslab_coarse) -->
<!-- ``` -->


```{r}
vec_covar_cell_filter = c("nCount_RNA", "percent.mito")
```

```{r}
list_dt_covar_cor = lapply(vec_celltypesOfInterest, function(cell_clust) {
  #print(cell_clust)
  vec_mod_cell_clust = unique(dt_geneMod_perslab$module_filter[dt_geneMod_perslab$cell_cluster_filter==cell_clust])
  vec_mod_cell_clust = vec_mod_cell_clust[!is.na(vec_mod_cell_clust)]
  
  vec_logical_cells = seuratObj$cluster_perslab_coarse==cell_clust
  
  mat_covar_cor = sapply(vec_mod_cell_clust, function(module) {
    #print(module)
    cor(mat_embed[vec_logical_cells,gsub("perslab_", "", module)], df_covar_cell[vec_logical_cells,vec_covar_cell_filter])
  }) %>% t
  
  dt_out = data.table("module"= rownames(mat_covar_cor), mat_covar_cor, "n_cells"=sum(vec_logical_cells))
  
  colnames(dt_out)[c(2,3)] = vec_covar_cell_filter
  
  return(dt_out )
})

dt_covar_cor = rbindlist(list_dt_covar_cor)

```

```{r}
hist(dt_covar_cor$nCount_RNA, breaks = 25)
```

```{r}
hist(dt_covar_cor$percent.mito, breaks = 25)
```

```{r}
for (covar in vec_covar_cell_filter) {
  WGCNA::corPvalueStudent(cor=dt_covar_cor[[covar]], nSamples=dt_covar_cor[["n_cells"]]) %>% 
    p.adjust(p=., method = "BH") -> dt_covar_cor[[paste0(covar, "_p.value_BH")]] 
}

```

we see quite a high correlations
mean and mode > 0 for nCount_RNA, < 0 for percent.mito

statistical significance seems too strict, as we should expect biological processes to be correlated with these covariates. So what is a reasonable way to use the information?

One option is to filter out modules which are more driven by these covariates than by cell cluster membership 

```{r}
mat_covar_cor_allcells = cor(
  mat_embed[,gsub("\\.","-",colnames(mat_embed)) %in% gsub("perslab_", "", dt_geneMod_perslab$module_filter)],
  df_covar_cell[,grep("nCount_RNA|percent\\.mito|coarse", colnames(df_covar_cell))])

```

```{r}
# for each row, get the column with the highest value
vec_idx_maxCol = apply(mat_covar_cor_allcells, 1, which.max)

table(colnames(mat_covar_cor_allcells)[vec_idx_maxCol])

   #      cluster_perslab_coarseCholangiocytes        cluster_perslab_coarseDendritic.cells 
   #                                        23                                            6 
   #   cluster_perslab_coarseEndothelial.cells cluster_perslab_coarseHepatic.stellate.cells 
   #                                        49                                           14 
   #  cluster_perslab_coarseHepatic.stem.cells            cluster_perslab_coarseHepatocytes 
   #                                         3                                           11 
   #         cluster_perslab_coarseMacrophages          cluster_perslab_coarseNK.like.cells 
   #                                        40                                           15 
   #        cluster_perslab_coarsePlasma.cells     cluster_perslab_coarseT.cells.alpha.beta 
   #                                         4                                           31 
   # cluster_perslab_coarseT.cells.gamma.delta                                   nCount_RNA 
   #                                         6                                           39 
   #                              percent.mito 
   #                                        12 
```


```{r}
vec_mods_perslab_keep = rownames(mat_covar_cor_allcells)[!colnames(mat_covar_cor_allcells)[vec_idx_maxCol] %in% vec_covar_cell_filter]
length(vec_mods_perslab_keep)
# [1] 202
```

filter modules (don't overwrite existing filter columns)

```{r}

dt_geneMod_perslab[,module_filter:=ifelse(gsub("perslab_","", module_filter) %in% ..vec_mods_perslab_keep, module_filter,NA),]

dt_geneMod_perslab[,cell_cluster_filter_rev:=ifelse(is.na(module_filter), NA, cell_cluster_filter),]
```


## Filter out modules if marker genes of other cell-types enrich for them

```{r}
DefaultAssay(seuratObj_sub) <- "SCT_combat"

seuratObj_sub <- NormalizeData(
  seuratObj_sub,
  normalization.method = "LogNormalize",
  assay = "SCT_combat") # this is what SCTransform does as well, i.e log(x+1)
# required for "MAST" DE test

vec_clusters = seuratObj_sub@meta.data$cluster_perslab_coarse %>% unique

Idents(seuratObj_sub) <- seuratObj_sub@meta.data$cluster_perslab_coarse

```

```{r}

list_iterable = list("X"=vec_clusters)
fun = function(cluster) {tryCatch({
  FindMarkers(seuratObj_sub ,
          #cells.1=colnames(seurat_obj)[Idents(seurat_obj)==cluster],
          #cells.2=NULL,
          ident.1 = cluster,
          only.pos = F,
          #slot="counts",
          #ident.2 = clusters[clusters!=cluster],
          logfc.threshold = 0,
          #test.use  ="MAST",
          test.use  ="wilcox",
          min.pct= 0,
          #max.cells.per.ident=1000,
          random.seed=randomSeed,
          #latent.vars = if (!is.null(merge_specify) | !is.null(merge_group_IDs)) "sample_ID" else NULL,
          verbose = T)
          },
          error = function(err) {
            NA_character_
            warning(paste0("findmarkers failed for ", cluster, " with error ", err))
          })}

list_markers=NULL
# do NOT parallelise, FindMarkers is already parallelised under the hood!
list_markers <- lapply(FUN=fun, "X"=list_iterable[[1]])

# add the gene and cluster as a column
list_dt_markers <- mapply(function(df_markers, cluster) {
  if (!all(sapply(df_markers, is.na))) {
    cbind("gene" = rownames(df_markers), "cluster"=rep(cluster, nrow(df_markers)), df_markers) %>% setDT
  } else {
    NA_character_
  }
},
df_markers=list_markers,
cluster=vec_clusters, SIMPLIFY=F) 


names(list_dt_markers) <- vec_clusters
#list_markers <- list_markers[!sapply(list_markers, function(markers) all(is.na(markers)))]

# rownames(df_markers) <- NULL
# dt_markers  <- setDT(df_markers)
# dt_markers[,p_val_adj := p.adjust(p_val, method = "BH")]
#dt_markers$p_val_adj[dt_markers$p_val_adj==0] <- 1e-10
#dt_markers[,p_val_adj_minlog10 := -log10(p_val_adj)]
#dt_markers[,avg_LFC_weighted := p_val_adj_minlog10*avg_logFC]
```

```{r}
saveRDS(list_dt_markers,  file = "/projects/jonatan/pub-perslab/18-liver-fred/output/liver_perslab_int_SCTint_combat_list_wilcox_all_markers_cluster_perslab_coarse.RDS.gz", compress="gzip")
```

run geneset enrichment tests

```{r}
vec_mods_filter = unique(dt_geneMod_perslab[["module_filter"]])
vec_mods_filter = vec_mods_filter[!is.na(vec_mods_filter) & nchar(vec_mods_filter)>0]

# vec_clust_filter = names(list_dt_markers)#unique(seuratObj_sub$cluster_perslab_coarse)
# vec_clust_filter = vec_clust_filter[!is.na(vec_clust_filter) & nchar(vec_clust_filter)>0]

```

<!-- ```{r} -->
<!-- list_dt_mod_DEgenes_geneset_tests <- lapply(vec_mods_filter, function(mod_filter) { -->

<!--     condition_mod = quote(dt_geneMod_perslab[["module_filter"]]==mod_filter) -->

<!--     vec_mod_kIMs = dt_geneMod_perslab[eval(condition_mod), pkMs] -->
<!--     names(vec_mod_kIMs) = dt_geneMod_perslab[eval(condition_mod), genes] -->
<!--     # cell_clust_mod = dt_geneMod_perslab[eval(condition_mod),cell_cluster_filter] %>% unique -->

<!--     # cell_clust_mod  =   gsub(pattern=c("alpha-", "beta", "gamma-", "delta")[i],  -->
<!--     # replacement=c(alpha_unicode, Beta_unicode, gamma_unicode, delta_unicode)[i], -->
<!--     # x=cell_clust_mod) -->

<!--     mat_out = sapply(vec_clust_filter, function(clust){  -->

<!--       condition_clust = quote(dt_markers$cluster==clust) -->
<!--       dt_markers_sub = dt_markers[eval(condition_clust)] -->


<!--       if (sum(dt_markers_sub[["gene"]] %in% names(vec_mod_pkMs))>0) { -->

<!--         condition_in = quote(dt_markers_sub[["gene"]] %in% names(vec_mod_pkMs)) -->
<!--         condition_out = quote(!dt_markers_sub[["gene"]] %in% names(vec_mod_pkMs)) -->


<!--         wilcox.out = wilcox.test(x=dt_markers_sub[eval(condition_in), avg_LFC_weighted],  -->
<!--                     y = dt_markers_sub[eval(condition_out), avg_LFC_weighted],  -->
<!--                     alternative = c("greater")) -->

<!--         c("statistic"=wilcox.out$statistic, "p.value"=wilcox.out$p.value) -->
<!--       } else { -->
<!--         c("statistic"=NA_real_, "p.value"=1) -->
<!--       } -->

<!--     }) %>% t  -->

<!--   dt_out <- data.table("module"= mod_filter, "cell_cluster" = rownames(mat_out), mat_out) -->
<!--   colnames(dt_out)[3:4] = c("statistic","p.value") -->
<!--   dt_out -->
<!-- }) -->

<!-- dt_mod_DEgenes_geneset_tests <- rbindlist(list_dt_mod_DEgenes_geneset_tests )  -->
<!-- ``` -->



<!-- ```{r} -->
<!-- list_mat_clustDEgenes_mod_geneset_tests <- lapply(vec_clust_filter, function(clust){  -->

<!--       condition_clust = quote(dt_markers$cluster==clust) -->

<!--       vec_clust_LFC_weighted = dt_markers[eval(condition_clust), avg_LFC_weighted] -->

<!--       names(vec_clust_LFC_weighted) <- dt_markers[eval(condition_clust), gene] -->

<!--       vec_clust_LFC_weighted <- sort(vec_clust_LFC_weighted, decreasing=TRUE) -->
<!--       # list_vec_kIMs = lapply(vec_mods_filter, function(mod_filter) { -->
<!--       #    condition_mod = quote(dt_geneMod_perslab[["module_filter"]]==mod_filter) -->
<!--       #    vec_mod_kIMs = dt_geneMod_perslab[eval(condition_mod), pkMs] -->
<!--       #    names(vec_mod_kIMs) = dt_geneMod_perslab[eval(condition_mod), genes] -->
<!--       #    return(vec_mod_kIMs) -->
<!--       # })  -->
<!--       list_mod_genes = lapply(vec_mods_filter, function(mod_filter) { -->
<!--          condition_mod = quote(dt_geneMod_perslab[["module_filter"]]==mod_filter) -->
<!--          dt_geneMod_perslab[eval(condition_mod), genes] -->
<!--       })  -->

<!--       iterative.bulk.gsea(values = vec_clust_LFC_weighted,   -->
<!--                           set.list = list_mod_genes,  -->
<!--                           verbose = T) -->
<!-- }) -->


<!-- names(list_mat_clustDEgenes_mod_geneset_tests) <- vec_clust_filter -->

<!-- list_dt_clustDEgenes_mod_geneset_tests <- lapply(vec_clust_filter, function(clust) { -->

<!--   mat_clustDEgenes_mod_geneset_tests <- list_mat_clustDEgenes_mod_geneset_tests[[clust]] -->
<!--   dt_out = data.table("cell_cluster"= clust, "module"=vec_mods_filter, mat_clustDEgenes_mod_geneset_tests)  -->
<!-- }) -->


<!-- dt_mod_DEgenes_geneset_tests <- rbindlist(list_dt_clustDEgenes_mod_geneset_tests)  -->
<!-- ``` -->

```{r}

list_vec_kIMs = lapply(vec_mods_filter, function(mod_filter) {
   condition_mod = quote(dt_geneMod_perslab[["module_filter"]]==mod_filter)
   vec_mod_kIMs = dt_geneMod_perslab[eval(condition_mod), pkMs]
   vec_mod_kIMs = vec_mod_kIMs/sum(vec_mod_kIMs) # normalize
   names(vec_mod_kIMs) = dt_geneMod_perslab[eval(condition_mod), genes]
   return(vec_mod_kIMs)
})
names(list_vec_kIMs) = vec_mods_filter


```

```{r}
  
mat_p_genesettest <- sapply(vec_clusters, function(clust){ 
      
      #condition_clust = quote(dt_markers$cluster==clust)
      
      vec_clust_LFC = list_dt_markers[[clust]][,avg_logFC] 
      
      names(vec_clust_LFC) <- list_dt_markers[[clust]][,gene]
      
      #vec_clust_LFC <- sort(vec_clust_LFC, decreasing=TRUE)
      

      #returns a R+1 * n_module matrix
      # mat_null_out = safeParallel(list_iterable=list("X"=list_vec_kIMs), 
      #                simplify=T,
      #                n_cores=23, 
      #                Gb_max=200,
      mat_null_out = sapply(X =  list_vec_kIMs, FUN = function(vec_kIMs) {
                        vec_idx = match(names(vec_kIMs), names(vec_clust_LFC))
                        if (all(is.na(vec_idx))) {
                          return(rep(0, R+1))
                          } else {
                            vec_kIMs = vec_kIMs[!is.na(vec_idx)]
                            vec_idx = vec_idx[!is.na(vec_idx)]
                            dot_product = vec_clust_LFC[vec_idx] %*% vec_kIMs # returns a 1*1 matrix
                            vec_dotProduct_null = sapply(1:R, function(i) {
                              sample(x=vec_clust_LFC, size=length(vec_idx), replace = F) %*% vec_kIMs})
                        
                            c(dot_product, vec_dotProduct_null)
                        }
                     })
      
      vec_p = apply(mat_null_out, MARGIN=2, FUN=function(eachcol){
        (0.5+sum(eachcol[2:length(eachcol)]>eachcol[1]))/(length(eachcol)-1)
      })
      
      names(vec_p) = vec_mods_filter
      
      vec_p
      
})

```

# remove ribosomal genes from markers 

```{r}
  # remove ribo
list_dt_markers_rm_ribo = lapply(list_dt_markers, function(dt_markers)   {
  #regex = "^RP[SL]\\D?"
  #print(dt_markers[grepl(pattern = "^Rp[sl]\\D[[:digit:]]", x = gene, ignore.case=T),gene])
  dt_markers[!grepl(pattern = "^RP[SL]\\D?[[:digit:]]", x = gene)]
}) 


```

```{r}
  
mat_p_genesettest_rm_ribo <- sapply(vec_clusters, function(clust){ 
      
      #condition_clust = quote(dt_markers$cluster==clust)
      
      vec_clust_LFC = list_dt_markers_rm_ribo[[clust]][,avg_logFC] 
      
      names(vec_clust_LFC) <- list_dt_markers_rm_ribo[[clust]][,gene]
    
      #vec_clust_LFC <- sort(vec_clust_LFC, decreasing=TRUE)
      

      #returns a R+1 * n_module matrix
      # mat_null_out = safeParallel(list_iterable=list("X"=list_vec_kIMs), 
      #                simplify=T,
      #                n_cores=23, 
      #                Gb_max=200,
      mat_null_out = sapply(X =  list_vec_kIMs, FUN = function(vec_kIMs) {
                        vec_idx = match(names(vec_kIMs), names(vec_clust_LFC))
                        if (all(is.na(vec_idx))) {
                          return(rep(0, R+1))
                          } else {
                            vec_kIMs = vec_kIMs[!is.na(vec_idx)]
                            vec_idx = vec_idx[!is.na(vec_idx)]
                            dot_product = vec_clust_LFC[vec_idx] %*% vec_kIMs # returns a 1*1 matrix
                            vec_dotProduct_null = sapply(1:R, function(i) {
                              sample(x=vec_clust_LFC, size=length(vec_idx), replace = F) %*% vec_kIMs})
                        
                            c(dot_product, vec_dotProduct_null)
                        }
                     })
      
      vec_p = apply(mat_null_out, MARGIN=2, FUN=function(eachcol){
        (0.5+sum(eachcol[2:length(eachcol)]>eachcol[1]))/(length(eachcol)-1)
      })
      
      names(vec_p) = vec_mods_filter
      
      vec_p
      
})

```


try with esmu instead of DE genes

```{r}
dt_esmu = fread("/projects/jonatan/pub-perslab/18-liver-fred/output/liver_perslab_int_seurat_7.esmu.csv.gz")
```

update column names 

```{r}
colnames(dt_esmu)[1] <- "gene"
```

unicode

```{r}
alpha_unicode = "\u03B1"
Beta_unicode = "\u03B2"
gamma_unicode = "\u03B3"
delta_unicode = "\u03B4"

for (i in 1:4) {
  
  colnames(dt_esmu) =   gsub(pattern=c("alpha-", "beta", "gamma-", "delta")[i], 
  replacement=c(alpha_unicode, Beta_unicode, gamma_unicode, delta_unicode)[i],
  x=colnames(dt_esmu))

}
```

remove ribosomal genes

```{r}
dt_esmu =  dt_esmu[!grepl(pattern = "^RP[SL]\\D?[[:digit:]]", x = gene)]
```


```{r}
  
mat_p_genesettest_esmu_rm_ribo <- sapply(vec_clusters, function(clust){ 
      
      #condition_clust = quote(dt_markers$cluster==clust)
      
      vec_clust_esmu = dt_esmu[,clust, with=F][[1]]
      
      names(vec_clust_esmu) <- dt_esmu[,"gene"][[1]]
    
      #vec_clust_LFC <- sort(vec_clust_LFC, decreasing=TRUE)
      

      #returns a R+1 * n_module matrix
      # mat_null_out = safeParallel(list_iterable=list("X"=list_vec_kIMs), 
      #                simplify=T,
      #                n_cores=23, 
      #                Gb_max=200,
      mat_null_out = sapply(X =  list_vec_kIMs, FUN = function(vec_kIMs) {
                        vec_idx = match(names(vec_kIMs), names(vec_clust_esmu))
                        if (all(is.na(vec_idx))) {
                          return(rep(0, R+1))
                          } else {
                            vec_kIMs = vec_kIMs[!is.na(vec_idx)]
                            vec_idx = vec_idx[!is.na(vec_idx)]
                            dot_product = vec_clust_esmu[vec_idx] %*% vec_kIMs # returns a 1*1 matrix
                            vec_dotProduct_null = sapply(1:R, function(i) {
                              sample(x=vec_clust_esmu, size=length(vec_idx), replace = F) %*% vec_kIMs})
                        
                            c(dot_product, vec_dotProduct_null)
                        }
                     })
      
      vec_p = apply(mat_null_out, MARGIN=2, FUN=function(eachcol){
        (0.5+sum(eachcol[2:length(eachcol)]>eachcol[1]))/(length(eachcol)-1)
      })
      
      names(vec_p) = vec_mods_filter
      
      vec_p
      
})

```


find modules with a greater affinity to another than to their own 

```{r}
dict_mod_cellclust = dt_geneMod_perslab[,c("module_filter","cell_cluster_filter", "module_renamed")]
dict_mod_cellclust = dict_mod_cellclust[!duplicated(module_filter) & nchar(module_filter)>0]
```

```{r}
alpha_unicode = "\u03B1"
Beta_unicode = "\u03B2"
gamma_unicode = "\u03B3"
delta_unicode = "\u03B4"

for (i in 1:4) {
  
  dict_mod_cellclust$cell_cluster_filter=   gsub(pattern=c("alpha-", "beta", "gamma-", "delta")[i], 
  replacement=c(alpha_unicode, Beta_unicode, gamma_unicode, delta_unicode)[i],
  x=dict_mod_cellclust$cell_cluster_filter)

}
```

adjust p-values

```{r}
mat_p_genesettest_adj = apply(mat_p_genesettest, MARGIN = 2, FUN=function(eachcol) {
  p.adjust(p = eachcol, method="BH", n = nrow(mat_p_genesettest)*ncol(mat_p_genesettest))})
```

```{r}
mat_p_genesettest_rm_ribo_adj = apply(mat_p_genesettest_rm_ribo, MARGIN = 2, FUN=function(eachcol) {
  p.adjust(p = eachcol, method="BH", n = nrow(mat_p_genesettest_rm_ribo)*ncol(mat_p_genesettest_rm_ribo))})
```


```{r}
mat_p_genesettest_esmu_rm_ribo_adj = apply(mat_p_genesettest_esmu_rm_ribo, MARGIN = 2, FUN=function(eachcol) {
  p.adjust(p = eachcol, method="BH", n = nrow(mat_p_genesettest_esmu_rm_ribo)*ncol(mat_p_genesettest_esmu_rm_ribo))})
```

if a module enriched higher for another cell type than for its own, and significantly so, it is contaminated

```{r}

vec_contaminated = sapply(rownames(mat_p_genesettest_adj), function(mod_filter) {

  most_enriched_cell_cluster <- colnames(mat_p_genesettest_adj)[which.min(mat_p_genesettest_adj[mod_filter,])] 
  
  mod_cell_cluster = dict_mod_cellclust$cell_cluster_filter[dict_mod_cellclust$module_filter==mod_filter]
    print("")
  print(paste0(mod_filter,": from ", mod_cell_cluster, ", most enriched: ", most_enriched_cell_cluster))
  
  return( if (most_enriched_cell_cluster!=mod_cell_cluster &
            mat_p_genesettest_adj[mod_filter,most_enriched_cell_cluster] < 0.05 &
            mat_p_genesettest_adj[mod_filter,mod_cell_cluster] >= 0.05
            ) TRUE else FALSE)

})

```


```{r}

dt_contaminated_rm_ribo = sapply(rownames(mat_p_genesettest_rm_ribo_adj), function(mod_filter) {

  most_enriched_cell_cluster <- colnames(mat_p_genesettest_rm_ribo_adj)[which.min(mat_p_genesettest_rm_ribo_adj[mod_filter,])] 
  
  mod_cell_cluster = dict_mod_cellclust$cell_cluster_filter[dict_mod_cellclust$module_filter==mod_filter]
    print("")
  print(paste0(mod_filter,": from ", mod_cell_cluster, ", most enriched: ", most_enriched_cell_cluster))
  
  c("module"=mod_filter,
    "cell_cluster_origin"=mod_cell_cluster,
    "cell_cluster_origin_padj"=mat_p_genesettest_rm_ribo_adj[mod_filter,mod_cell_cluster],
    "cell_cluster_max_enriched"=most_enriched_cell_cluster,
    "cell_cluster_max_enriched_padj"=mat_p_genesettest_rm_ribo_adj[mod_filter,most_enriched_cell_cluster],
    "contaminated" = if (most_enriched_cell_cluster!=mod_cell_cluster &
            mat_p_genesettest_rm_ribo_adj[mod_filter,most_enriched_cell_cluster] < 0.05 &
            mat_p_genesettest_rm_ribo_adj[mod_filter,mod_cell_cluster] >= 0.05
            ) TRUE else FALSE)

}) %>% t %>% data.table()

dt_contaminated_rm_ribo
```


```{r}

dt_contaminated_esmu_rm_ribo = sapply(rownames(mat_p_genesettest_esmu_rm_ribo_adj), function(mod_filter) {

  most_enriched_cell_cluster <- colnames(mat_p_genesettest_esmu_rm_ribo_adj)[which.min(mat_p_genesettest_esmu_rm_ribo_adj[mod_filter,])] 
  
  mod_cell_cluster = dict_mod_cellclust$cell_cluster_filter[dict_mod_cellclust$module_filter==mod_filter]
  print("")
  print(paste0(mod_filter,": from ", mod_cell_cluster, ", most enriched: ", most_enriched_cell_cluster))
  
  c("module"=mod_filter,
    "cell_cluster_origin"=mod_cell_cluster,
    "cell_cluster_origin_padj"=mat_p_genesettest_esmu_rm_ribo_adj[mod_filter,mod_cell_cluster],
    "cell_cluster_max_enriched"=most_enriched_cell_cluster,
    "cell_cluster_max_enriched_padj"=mat_p_genesettest_esmu_rm_ribo_adj[mod_filter,most_enriched_cell_cluster],
    "contaminated" = if (most_enriched_cell_cluster!=mod_cell_cluster &
            mat_p_genesettest_esmu_rm_ribo_adj[mod_filter,most_enriched_cell_cluster] < 0.05 &
            mat_p_genesettest_esmu_rm_ribo_adj[mod_filter,mod_cell_cluster] >= 0.05
            ) TRUE else FALSE)

}) %>% t %>% data.table()

dt_contaminated_esmu_rm_ribo
```

```{r}
dt_contaminated_rm_ribo$module_renamed = ifelse(dt_contaminated_rm_ribo$module %in% dict_mod_cellclust$module_filter, dict_mod_cellclust$module_renamed[match(dt_contaminated_rm_ribo$module, dict_mod_cellclust$module_filter)], NA)
```

```{r}
dt_contaminated_esmu_rm_ribo$module_renamed = ifelse(dt_contaminated_esmu_rm_ribo$module %in% dict_mod_cellclust$module_filter, dict_mod_cellclust$module_renamed[match(dt_contaminated_esmu_rm_ribo$module, dict_mod_cellclust$module_filter)], NA)
```

```{r}
dt_contaminated_rm_ribo$cell_cluster_origin_padj <- as.numeric(dt_contaminated_rm_ribo$cell_cluster_origin_padj)

dt_contaminated_rm_ribo$cell_cluster_max_enriched_padj <- as.numeric(dt_contaminated_rm_ribo$cell_cluster_max_enriched_padj)

dt_contaminated_rm_ribo$contaminated <- as.logical(dt_contaminated_rm_ribo$contaminated)
```

```{r}
dt_contaminated_esmu_rm_ribo$cell_cluster_origin_padj <- as.numeric(dt_contaminated_esmu_rm_ribo$cell_cluster_origin_padj)

dt_contaminated_esmu_rm_ribo$cell_cluster_max_enriched_padj <- as.numeric(dt_contaminated_esmu_rm_ribo$cell_cluster_max_enriched_padj)

dt_contaminated_esmu_rm_ribo$contaminated <- as.logical(dt_contaminated_esmu_rm_ribo$contaminated)
```


how do results compare with DE genes and esmu?

```{r}
sum(dt_contaminated_esmu_rm_ribo[contaminated==TRUE,module] %in% dt_contaminated_rm_ribo[contaminated==TRUE,module])
```

what modules are not filtered when using esmu? 

```{r}
vec_diff_DE_esmu = setdiff(dt_contaminated_rm_ribo[contaminated==TRUE,module],dt_contaminated_esmu_rm_ribo[contaminated==TRUE,module])

vec_diff_DE_esmu <- ifelse(nchar(dict_mod_cellclust$module_renamed[match(vec_diff_DE_esmu, dict_mod_cellclust$module_filter)])>0, dict_mod_cellclust$module_renamed[match(vec_diff_DE_esmu, dict_mod_cellclust$module_filter)], vec_diff_DE_esmu)
```

```{r}
vec_diff_esmu_DE = setdiff(dt_contaminated_esmu_rm_ribo[contaminated==TRUE,module],dt_contaminated_rm_ribo[contaminated==TRUE,module])

vec_diff_esmu_DE <- ifelse(nchar(dict_mod_cellclust$module_renamed[match(vec_diff_esmu_DE, dict_mod_cellclust$module_filter)])>0, dict_mod_cellclust$module_renamed[match(vec_diff_esmu_DE, dict_mod_cellclust$module_filter)], vec_diff_esmu_DE)
```



```{r}
fwrite(dt_contaminated_rm_ribo, here("output",paste0(prefixData , "_", prefixRun, "_dt_contaminated_rm_ribo_", flagDate, ".csv")))

openxlsx::write.xlsx(dt_contaminated_rm_ribo, here("output",paste0(prefixData , "_", prefixRun, "_dt_contaminated_rm_ribo_", flagDate, ".xlsx")))
```

```{r}
fwrite(dt_contaminated_esmu_rm_ribo, here("output",paste0(prefixData , "_", prefixRun, "_dt_contaminated_esmu_rm_ribo_", flagDate, ".csv")))

openxlsx::write.xlsx(dt_contaminated_esmu_rm_ribo, here("output",paste0(prefixData , "_", prefixRun, "_dt_contaminated_esmu_rm_ribo_", flagDate, ".xlsx")))
```


```{r}
table(vec_contaminated_rm_ribo)
# vec_contaminated_rm_ribo
# FALSE  TRUE 
#   134    68 
table(vec_contaminated)
# vec_contaminated
# FALSE  TRUE 
#   131    71 
```

which modules have been spared?

```{r}
vec_spared_by_rm_ribo = names(vec_contaminated)[vec_contaminated][!names(vec_contaminated)[vec_contaminated] %in% names(vec_contaminated_rm_ribo)[vec_contaminated_rm_ribo]]

```

```{r}
dict_mod_cellclust$module_renamed[match(vec_spared_by_rm_ribo, dict_mod_cellclust$module_filter)]
```

which modules have been removed that were spared before?

```{r}
vec_gone_by_rm_ribo = names(vec_contaminated_rm_ribo)[vec_contaminated_rm_ribo][!names(vec_contaminated_rm_ribo)[vec_contaminated_rm_ribo] %in% names(vec_contaminated)[vec_contaminated]]

```




<!-- now look at contamination from specific clusters -->

<!-- ```{r} -->
<!-- clust = "Hepatocytes" -->
<!-- ``` -->

<!-- ```{r} -->

<!-- vec_contaminated_clust = sapply(rownames(mat_p_genesettest_adj), function(mod_filter) { -->

<!--   most_enriched_cell_cluster <- colnames(mat_p_genesettest_adj)[which.min(mat_p_genesettest_adj[mod_filter,])]  -->

<!--   mod_cell_cluster = dict_mod_cellclust$cell_cluster_filter[dict_mod_cellclust$module_filter==mod_filter] -->


<!--   return( if (most_enriched_cell_cluster== clust & -->
<!--             most_enriched_cell_cluster!=mod_cell_cluster & -->
<!--             mat_p_genesettest_adj[mod_filter,most_enriched_cell_cluster] < 0.05 & -->
<!--             mat_p_genesettest_adj[mod_filter,mod_cell_cluster] >= 0.05 -->
<!--             ) TRUE else FALSE) -->

<!-- }) -->

<!-- ``` -->

<!-- ```{r} -->
<!-- names(vec_contaminated_clust)[vec_contaminated_clust] -->
<!-- ``` -->

<!-- get new names where they exist  -->

<!-- ```{r} -->
<!-- names(vec_contaminated_clust)[vec_contaminated_clust]  = ifelse( -->
<!--   nchar(dict_mod_cellclust$module_renamed[match(names(vec_contaminated_clust)[vec_contaminated_clust] , dict_mod_cellclust$module_filter)])>0,  dict_mod_cellclust$module_renamed[match(names(vec_contaminated_clust)[vec_contaminated_clust] , dict_mod_cellclust$module_filter)], names(vec_contaminated_clust)) -->
<!-- ``` -->


```{r}
table(vec_contaminated)
# FALSE  TRUE 
#   131    71 
```

<!-- ```{r} -->
<!-- dt_mod_DEgenes_geneset_tests[,p.value_adjust := p.adjust(p.value, method="BH")] -->

<!-- dt_mod_DEgenes_geneset_tests$mod_cell_cluster <- dict_mod_cellclust$cell_cluster_filter[match(dt_mod_DEgenes_geneset_tests$module, dict_mod_cellclust$module_filter)] -->

<!-- dt_mod_DEgenes_geneset_tests$most_enriched_cell_cluster <- NA -->
<!-- ``` -->

<!-- if a module enriched higher for another celltype than for its own, and significantly so, it is contaminated -->

<!-- ```{r} -->

<!-- #dt_mod_DEgenes_geneset_tests$contaminated <- FALSE -->

<!-- vec_contaminated = sapply(unique(dt_mod_DEgenes_geneset_tests$module), function(mod_filter) { -->

<!--   #mod_celltype = dict_mod_cellclust$cell_cluster_filter[match(mod_filter,dict_mod_cellclust$module_filter)] -->
<!--   condition_mod = quote(dt_mod_DEgenes_geneset_tests$module==mod_filter) -->
<!--   #dt_mod_DEgenes_geneset_tests_sub = dt_mod_DEgenes_geneset_tests[eval(condition_mod)] -->
<!--   most_enriched_cell_cluster <-  dt_mod_DEgenes_geneset_tests[eval(condition_mod),cell_cluster][which.min(dt_mod_DEgenes_geneset_tests[eval(condition_mod), p.value_adjust])] -->

<!--   print("") -->
<!--   print(most_enriched_cell_cluster) -->
<!--   print(dt_mod_DEgenes_geneset_tests[eval(condition_mod),mod_cell_cluster] %>% unique) -->

<!--   contaminated = if ((most_enriched_cell_cluster != dt_mod_DEgenes_geneset_tests[eval(condition_mod),mod_cell_cluster] %>% unique) & min(dt_mod_DEgenes_geneset_tests[eval(condition_mod), p.value_adjust]) < 0.05) TRUE else FALSE  -->

<!--   return(contaminated) -->
<!-- }) -->

<!-- ``` -->


since we added this last contamination step after doing everything else, which of the modules that were found to be contaminated downstream are caught by this intervention upstream?

looking at p_heatmap_moduleGeneIntersect_perslab_clustermarkers, the following looked suspicious:

```{r}
vec_mods_pres_but_contaminated = dict_mod_cellclust$module_renamed[match(names(vec_contaminated)[vec_contaminated], dict_mod_cellclust$module_filter)]

vec_mods_pres_but_contaminated  <- vec_mods_pres_but_contaminated[nchar(vec_mods_pres_but_contaminated)>0]
```


<!-- ```{r} -->
<!-- vec_mods_suspected_contaminated_1 = c("Endothelial-cells_6", "Dendritic-cells_3", "NK-like-cells_1", "Cholangiocytes_3", "Hepatic-stellate-cells_5", "T-cells-gamma-delta_1", "Hepatocytes_2", "Plasma-cells_1", "Hepatic-stem-cells_1", "B-cells-mature_1", "T-cells-alpha-beta_1") # the last two not so much  -->

<!-- vec_mods_suspected_contaminated_2 = c("Cholangiocytes_2","NK-like-cells_2", "Endothelial-cells_4", "T-cells-gamma-delta_4", "Cholangiocytes_1", "Hepatic-stellate-cells_4") -->

<!-- vec_mods_suspected_contaminated_3 = c("Endothelial-cells_2", "T-cells-gamma-delta_2", "T-cells-alpha-beta_2", "Hepatocytes_1", "Cholangiocytes_4", "Endothelial-cells_7") -->

<!-- ``` -->


<!-- ```{r} -->
<!-- table(c(vec_mods_suspected_contaminated_1 ,vec_mods_suspected_contaminated_2,vec_mods_suspected_contaminated_3) %in% vec_mods_pres_but_contaminated ) -->
<!-- # FALSE  TRUE  -->
<!-- #    13    10  -->

<!-- # c(vec_mods_suspected_contaminated_1 ,vec_mods_suspected_contaminated_2,vec_mods_suspected_contaminated_3)[c(vec_mods_suspected_contaminated_1 ,vec_mods_suspected_contaminated_2,vec_mods_suspected_contaminated_3) %in% vec_mods_pres_but_contaminated]  -->
<!-- ``` -->




```{r}
n_max_markers_use = 100
```

```{r}
list_vec_topmarkers =   lapply(names(list_dt_markers_rm_ribo), function(clust_name) {
  vec_markers = list_dt_markers_rm_ribo[[clust_name]]$gene[list_dt_markers_rm_ribo[[clust_name]]$p_val_adj < 0.05]
  vec_markers = 
  vec_markers[1:min(n_max_markers_use, length(vec_markers))]
})

names(list_vec_topmarkers) = names(list_dt_markers_rm_ribo)
```


check overlaps sc modules with marker genes


```{r}

list_genelists_perslab_contaminated_rm_ribo = lapply(dt_contaminated_rm_ribo[contaminated==TRUE,module], function(mod) {
  condition = quote(dt_geneMod_perslab[["module_filter"]]==mod)
  vec_mod_genes = dt_geneMod_perslab[eval(condition), genes, ] %>% unique
  return(vec_mod_genes)
})

names(list_genelists_perslab_contaminated_rm_ribo) = dt_contaminated_rm_ribo[contaminated==TRUE,module]

list_geneWeights_perslab_contaminated_rm_ribo = lapply(dt_contaminated_rm_ribo[contaminated==TRUE,module], function(mod) {
  condition = quote(dt_geneMod_perslab[["module_filter"]]==mod)
  vec_kIMs = dt_geneMod_perslab[eval(condition), pkMs, ]
  names(vec_kIMs) = dt_geneMod_perslab[eval(condition), genes, ]
  return(vec_kIMs)
})

names(list_geneWeights_perslab_contaminated_rm_ribo) = dt_contaminated_rm_ribo[contaminated==TRUE,module]


```

## plot which of the top marker genes are in the sc modules


```{r}

for (clust in vec_clusters) {
  
  pdf(file=here("plots", paste0(prefixData, "_",prefixRun, "_heatmap_mods_contaminated_top100_DEgenes_", clust, "_",flagDate, ".pdf")))
  
  mat_gene_markers_in_mod = sapply(list_geneWeights_perslab_contaminated_rm_ribo, function(vec_geneWeights) {
     vec_geneWeights_rank = order(vec_geneWeights)/length(vec_geneWeights)
     names(vec_geneWeights_rank) = names(vec_geneWeights)
      ifelse(list_vec_topmarkers[[clust]] %in% names(vec_geneWeights_rank), vec_geneWeights_rank, 0)
    })
  
  rownames(mat_gene_markers_in_mod) <- list_vec_topmarkers[[clust]]
  
  colnames(mat_gene_markers_in_mod) = ifelse(nchar(dict_mod_cellclust$module_renamed[match(colnames(mat_gene_markers_in_mod), dict_mod_cellclust$module_filter)])>0, yes=dict_mod_cellclust$module_renamed[match(colnames(mat_gene_markers_in_mod), dict_mod_cellclust$module_filter)], no=dict_mod_cellclust$module_filter[match(colnames(mat_gene_markers_in_mod), dict_mod_cellclust$module_filter)])
  
  pheatmap(mat_gene_markers_in_mod, 
                 cluster_rows = F, 
                 cluster_cols = F,
               fontsize_col = 9, #default 10      
               fontsize_row = 4, #default 10
                 legend=T,)#, treeheight_row=0, treeheight_col=0)
  
  dev.off()
}
```

```{r}


#here("plots", paste0(prefixData, "_", prefixRun, "_Fig2Aii_corr_mat_",flagDate,".pdf"))

```


1XX single cell modules after filtering on the confounding covariates and removing contaminated modules





<!-- likewise, at the donor level, we will filter out modules which are more driven by the cells coming from a particular donor than by relevant donor characteristics  (lobular_inflammation_grade, fibrosis grade, BMI?) -->

<!-- ```{r} -->
<!-- dt_covar_donor_embed = data.table(df_covar_donor, mat_embed) -->
<!-- ``` -->

<!-- ```{r} -->
<!-- dt_embed_donor_embed_avg = dt_covar_donor_embed[,lapply(.SD, mean), by=seuratObj$sample_ID] -->
<!-- ``` -->

<!-- ```{r} -->
<!-- df_embed_donor_embed_avg <- setDF(dt_embed_donor_embed_avg) -->
<!-- ``` -->


<!-- ```{r} -->
<!-- mat_covar_cor_donors = cor( -->
<!--   df_embed_donor_embed_avg[,gsub("\\.","",colnames(df_embed_donor_embed_avg)) %in% gsub("perslab_", "", dt_geneMod_perslab$module_filter)], -->
<!--   df_embed_donor_embed_avg[,grep("_grade|BMI|sample_", colnames(df_embed_donor_embed_avg))]) -->

<!-- ``` -->

<!-- ```{r} -->
<!-- vec_idx_maxCol_2 = apply(mat_covar_cor_donors, 1, which.max) -->

<!-- table(colnames(df_embed_donor_embed_avg[,grep("_grade|BMI|sample_", colnames(df_embed_donor_embed_avg))])[vec_idx_maxCol_2]) -->
<!-- ``` -->



<!-- merge highly overlapping single cell modules across cell types -->

<!-- # time Rscript /nfsdata/projects/jonatan/tools/sc-analysis/wgcna-src/geneNetworkScripts/gene_module_merge2.R  --path_df_NWA /projects/jonatan/pub-perslab/18-liver-wgcna/tables/liver_perslab_int_wgcna3_geneMod.csv.gz --colGeneNames genes --colModule module_filter --colCellClust cell_cluster_filter --colGeneWeights pkMs --cellClusters_keep 'c("T-cells-alpha-beta", "NK-like-cells", "Endothelial-cells", "T-cells-gamma-delta", "Macrophages", "Cholangiocytes", "Hepatocytes","Hepatic-stellate-cells", "Dendritic-cells", "Hepatic-stem-cells")' --minPropIntersect  0.7 --minWeightedCor  0.5 --minPropIntersect_iter_increase  1.01 --maxIter 25 --corMethod pearson --mergeOrPrune prune --dirOut /projects/jonatan/pub-perslab/18-liver-wgcna/ --prefixOut merge2 --doPlot  T --RAMGbMax 250 &> ./log/log_liver_merge201001.txt -->

<!-- re-load new geneMod table after pruning overlapping modules -->

<!-- ```{r} -->
<!-- dt_geneMod_perslab <-fread(file="/projects/jonatan/pub-perslab/18-liver-wgcna/tables/liver_perslab_int_wgcna3_geneMod.csv.gz") -->
<!-- ``` -->






filter modules (overwrite existing filter columns)

```{r}

dt_geneMod_perslab[,module_filter_contamination:=ifelse(dt_contaminated_esmu_rm_ribo$contaminated[match(module_filter, dt_contaminated_esmu_rm_ribo$module)], NA, module_filter),]

dt_geneMod_perslab[,cell_cluster_filter_contamination:=ifelse(is.na(module_filter), NA, cell_cluster_filter),]
```



```{r}
colCellClust <- "cell_cluster_merged"
colModule <- "module_merged"
```

<!-- ```{r} -->
<!-- dt_geneMod_moylan2013[,cell_cluster_merged:=cell_cluster] -->
<!-- dt_geneMod_moylan2013[,module_merged:=module] -->
<!-- ``` -->


```{r}
dt_geneMod_perslab[,module_merged:=module_filter_contamination]
dt_geneMod_perslab[,cell_cluster_merged:=cell_cluster_filter_contamination]

```

```{r}
dt_geneMod_gerhard2018[,cell_cluster_merged:=cell_cluster]
dt_geneMod_gerhard2018[,module_merged:=paste0("gerhard2018_",module)]
```

```{r}
length(unique(dt_geneMod_perslab$module_filter)[nchar(unique(dt_geneMod_perslab$module_filter))>0 & !is.na(unique(dt_geneMod_perslab$module_filter))])
# [1] 174
length(unique(dt_geneMod_perslab$module_merged)[nchar(unique(dt_geneMod_perslab$module_merged))>0])
# [1] 174
```

## write files to disk

```{r}
fwrite(dt_geneMod_perslab, file = "/projects/jonatan/pub-perslab/18-liver-wgcna/tables/liver_perslab_int_wgcna3_geneMod.csv.gz", compress="gzip")
```

```{r}
fwrite(dt_geneMod_gerhard2018, file = "/projects/jonatan/pub-perslab/18-liver-wgcna/tables/liver_gerhard2018_wgcna3_geneMod.csv.gz", compress="gzip")
```

<!-- ```{r} -->
<!-- fwrite(dt_geneMod_moylan2013, file = "/projects/jonatan/pub-perslab/18-liver-wgcna/tables/liver_moylan2013_wgcna1_geneMod.csv.gz", compress="gzip") -->
<!-- ``` -->

next: liver_module_preservation.Rmd
