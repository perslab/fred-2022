---
title: 'Liver - gene network geneset tests'
author: "Jon Thompson, Pers lab, rkm916 at ku dot dk"
date: "`r Sys.time()`" 
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
params: 
  date: !r substr(gsub("-","",as.character(Sys.Date())),3,1000)
  randomSeed: !r 12345
  pValThreshold: !r 0.05
# output:
#   html_notebook:
#     df_print: paged
#     number_sections: yes
#     toc: yes
#     toc_depth: 3
#     toc_float: yes
#   html_document:
#     df_print: paged
#     number_sections: yes
#     toc: yes
#     toc_depth: 3
#     toc_float: yes
---

# Setup

## Load packages

```{r}

library("data.table")
library("Matrix")
library("Seurat")
library("here")
library("magrittr")
```

## source utility functions

```{r}
source(here("/perslab-sc-library", "utility_functions.R"))
source(here("perslab-sc-library", "functions_sc.R"))
```

## Set options

```{r}
options(stringsAsFactors = F, 
        use="pairwise.complete.obs", 
        warn=1, 
        verbose=F,
        boot.parallel="multicore", # see ?boot: each worker process inherits the environment of the current session, including the workspace and the loaded namespaces and attached packages (but not the random number seed: see below). 
        boot.ncpus = 20,
        mc.cores=40 # for parallel computation
        ) 

```

## Set constants

```{r}
randomSeed = 12345
set.seed(randomSeed)

```


generic project constants 

```{r}

prefixData = "liver_perslab_int"
prefixRun = "seurat_7"
prefixOut <- "SCTint"


assayUse = "SCT_combat"
```

## load data

input: SC-Transform normalized and ComBat adjusted data

```{r}
pathSeuratObj <- "/nfsdata/projects/jonatan/pub-perslab/18-liver-fred/output/liver_perslab_int_seurat_7_SCTint_perslab_labels_seuratObj_combat.RDS.gz"
#pathSeuratObj <- "/nfsdata/projects/jonatan/pub-perslab/18-liver-fred/output/liver_perslab_int_seurat_7_SCTint_perslab_labels_seuratObj.RDS.gz"
  #dir(path=here("output"), pattern = paste0(".*",prefixRun, ".*\\.RDS\\.gz"), full.names = T)
seuratObj <- load_obj(pathSeuratObj)
```

## pre-processing

check that the cells in the @counts slot are the same as those in the @data slot (no filtering)

```{r}
dim(seuratObj@assays[[assayUse]]@counts)
# [1] 24617 21007
dim(seuratObj@assays[[assayUse]]@data)
# [1] 24617 21007
```

we use the SCT normalization performed on each sample separately (as opposed to 'SCTall')

```{r}
DefaultAssay(seuratObj) <- assayUse
```

Get SCT normalized counts

```{r}
dt_SCT_combat <- GetAssayData(object=seuratObj, assay=assay_use, slot ="counts") %>% as.data.table
dt_SCT_combat <- data.table("gene"=rownames(seuratObj), dt_SCT_combat)

dt_SCT_combat[0:5,0:5]

#             gene AAACCTGAGCGTGAAC_1 AAACCTGAGCTCCTCT_1 AAACGGGCATGCAATC_1 AAAGATGTCCACGACG_1
# 1:    AL627309.1                  0                  0                  0                  0
# 2:    AP006222.2                  0                  0                  0                  0
# 3: RP4-669L17.10                  0                  0                  0                  0
# 4: RP11-206L10.3                  0                  0                  0                  0
# 5: RP11-206L10.2                  0                  0                  0                  0
```

map genes to ensembl 
average over duplicates

```{r}
dt_mapping <- fread("/projects/jonatan/tools/data/gene_annotation_hsapiens.txt.gz")
head(dt_mapping)
```

```{r}
dt_SCT <- gene_map(dataIn = dt_SCT_combat, 
                   colGene = "gene", 
                   replace=T, 
                   df_mapping = dt_mapping, 
                   from="hgnc_symbol", 
                   to="ensembl_gene_id", 
                   na.rm=T)
```

```{r}
dt_SCT_combat[0:5,0:5]
#    ensembl_gene_id AAACCTGAGCGTGAAC_1 AAACCTGAGCTCCTCT_1 AAACGGGCATGCAATC_1 AAAGATGTCCACGACG_1
# 1: ENSG00000225880                  0                  0                  0                  0
# 2: ENSG00000230368                  0                  0                  0                  0
# 3: ENSG00000187634                  0                  0                  0                  0
# 4: ENSG00000188976                  0                  0                  0                  0
# 5: ENSG00000187961                  0                  0                  0                  0
```

```{r}
dim(dt_SCT_combat)
# [1] 17965 21008
```

get metadata cell_ID and celltype

```{r}
dt_metadata <- data.table("cell_id"= colnames(seuratObj), "cell_type"=seuratObj$cluster_perslab_coarse)

```

```{r}
dt_metadata[,.N,by=cell_type]
#                  cell_type    N
#  1:     T-cells-alpha-beta 4194
#  2:    T-cells-gamma-delta 1804
#  3:           Erythrocytes 1380
#  4:          NK-like-cells 2469
#  5:      Endothelial-cells 4853
#  6:            Macrophages 3613
#  7:        Dendritic-cells  149
#  8:            Hepatocytes  745
#  9:         Cholangiocytes  915
# 10:         B-cells-mature  332
# 11:           Plasma-cells  156
# 12: Hepatic-stellate-cells  348
# 13:     Hepatic-stem-cells   49
```

## write out to disk

```{r}
# counts 
path_SCT_combat <- here("data", paste0(prefixData, "_", prefixRun, "_counts_SCT_combat.csv"))
saveMeta(savefnc = fwrite, x =dt_SCT_combat, file = path_SCT_combat)
system2(command="gzip", args = path_SCT_combat)

# metadata
path_metadata <- here("data", paste0(prefixData, "_", prefixRun, "_metadata.csv"))
# already written the same file for CELLEX
if(!file.exists(path_metadata <- here("data", paste0(prefixData, "_", prefixRun, "_metadata.csv")))) saveMeta(savefnc = fwrite, x =dt_metadata, file = path_metadata)

```


