---
title: 'Liver - gene module plots'
author: "Jon Thompson, Pers lab, rkm916 at ku dot dk"
date: "`r Sys.time()`" 
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
params: 
  date: !r substr(gsub("-","",as.character(Sys.Date())),3,1000)
  randomSeed: !r 12345
  pValThreshold: !r 0.05
# output:
#   html_notebook:
#     df_print: paged
#     number_sections: yes
#     toc: yes
#     toc_depth: 3
#     toc_float: yes
#   html_document:
#     df_print: paged
#     number_sections: yes
#     toc: yes
#     toc_depth: 3
#     toc_float: yes
---

Notes
EXERCISE CAUTION, SOME PARTS MAY BE OUT OF DATE
UP TO DATE:
* beta plots

# Setup

## Set options

```{r}
options(stringsAsFactors = F, 
        use="pairwise.complete.obs", 
        warn=1, 
        verbose=F,
        mc.cores=40 # for parallel computation
        ) 

randomSeed = 12345
set.seed(randomSeed)

pAdjMethod = "BH"
pValThreshold = 0.05 #params$pValThreshold

flagDate = substr(gsub("-","",as.character(Sys.Date())),3,1000)

# Load packages

#ipak(c("Seurat", "dplyr", "ggplot2", "Matrix", "parallel", "readr", "tidyr"))
library("Seurat")
library("data.table")
library("dplyr")
library("ggplot2")
library("Matrix")
library("parallel")
library("RColorBrewer")
library("ggsci")
#library("readr")
#library("tidyr")
library("here")
#library("lme4")
#library("WGCNA")
#library("dendextend")
#library("ggdendro")
#library("ComplexHeatmap")
#library("corrplot")
#devtools::install_github(repo = "satijalab/seurat", ref = "develop")

## source utility functions

source(here("perslab-sc-library", "utility_functions.R"))
source(here("perslab-sc-library", "functions_sc.R"))

# Set constants

# generic project constants 

#prefixData <- "aizarani"
prefixData = "liver_perslab_int"
prefixRun = "seurat_7"
prefixRunWGCNA = "wgcna3"
prefixOut <- "SCTint"

dirWGCNA_outs = "/projects/jonatan/pub-perslab/18-liver-wgcna/"
dirWGCNA_plots = paste0(dirWGCNA_outs, "plots/" )
dirWGCNA_RObjects = paste0(dirWGCNA_outs, "RObjects/" )
dirWGCNA_tables = paste0(dirWGCNA_outs, "tables/" )

colModule = "module_assoc"
colCellCluster = "cell_cluster_assoc"
```

## load data

Seurat object contains expression data and cell + patient-level metadata

```{r}
path_seuratObj <- here("output", paste0(prefixData, "_", prefixRun, "_", prefixOut, "_perslab_labels_seuratObj.RDS.gz"))

seuratObj <- load_obj(path_seuratObj)
```

Load modules dataframes

```{r}
dt_geneMod_perslab <- fread("/projects/jonatan/pub-perslab/18-liver-wgcna/tables/liver_perslab_int_wgcna3_geneMod.csv.gz")
head(dt_geneMod_perslab)
```

```{r}
dt_geneMod_gerhard <- fread("/projects/jonatan/pub-perslab/18-liver-wgcna/tables/liver_gerhard2018_wgcna3_geneMod.csv.gz")

```

```{r}
dt_geneMod_comb = rbindlist(list(dt_geneMod_perslab, dt_geneMod_gerhard))
```

load association results

<!-- ```{r} -->
<!-- list_dt_condition_coef = lapply(c("steatosis","lob_inflam", "fibrosis"), function(condition) { -->
<!--   fread(file = paste0(dirWGCNA_tables, prefixData, "_sc_bulk_modules_scaled_",condition,"_association_in_gerhard2018_200511.csv"))}) -->
<!-- ``` -->

```{r}
dt_condition_coef <- fread(paste0(dirWGCNA_tables, prefixData, "_mod_assoc_in_gerhard2018_BH_201023.csv"))
```

## plot dendrogram of mac mods

```{r}
library("WGCNA")
library("Seurat")
```

```{r}
datExpr = subset(x=seuratObj, subset = cluster_perslab_coarse == "Macrophages") %>% GetAssayData(., assay = "SCT_combat", slot = "data") %>% as.matrix %>% t
```

subset to keep variable genes

```{r}
seuratObj <- FindVariableFeatures(seuratObj, nfeatures = 2000)
```

```{r}
datExpr = datExpr[,VariableFeatures(seuratObj)]
```

```{r}
dim(datExpr)
# [1] 3613 2000
```

```{r}
powers = c(c(1:10), seq(from = 12, to=20, by=2))
```

```{r}
sft = pickSoftThreshold(datExpr, powerVector = powers, verbose = 5)
```

plot softpower scale free fits

```{r}
sizeGrWindow(9, 5)
par(mfrow = c(1,2));
cex1 = 0.9;
plot(sft$fitIndices[,1], -sign(sft$fitIndices[,3])*sft$fitIndices[,2],
xlab="Soft Threshold (power)",ylab="Scale Free Topology Model Fit,signed R^2",type="n",
main = paste("Scale independence"));
text(sft$fitIndices[,1], -sign(sft$fitIndices[,3])*sft$fitIndices[,2],
labels=powers,cex=cex1,col="red");
```

mean connectivity
```{r}
plot(sft$fitIndices[,1], sft$fitIndices[,5],
xlab="Soft Threshold (power)",ylab="Mean Connectivity", type="n",
main = paste("Mean connectivity"))
text(sft$fitIndices[,1], sft$fitIndices[,5], labels=powers, cex=cex1,col="red")
```

construct network 

```{r}
net = blockwiseModules(datExpr, power = 2,
                       TOMType = "signed",
                       minModuleSize = 20,
                       reassignThreshold = 0,
                       mergeCutHeight = 0.25,
                       numericLabels = TRUE, 
                       pamStage=FALSE,
                       #pamRespectsDendro = FALSE,
                       saveTOMs = FALSE,
                       verbose = 3)
```

plot dendro

```{r}

mergedColors = labels2colors(net$colors)
pdf(file = paste0(dirWGCNA_plots, prefixData, "_", prefixRun, "_wgcna_dendroplot_macs.pdf"))
# open a graphics window
#sizeGrWindow(12, 9)
# Convert labels to colors for plotting

# Plot the dendrogram and the module colors underneath
plotDendroAndColors(net$dendrograms[[1]], mergedColors[net$blockGenes[[1]]],
"Module colors",dendroLabels = FALSE, hang = 0.03,addGuide = TRUE, guideHang = 0.05)
dev.off()
```

## plot association betas with confidence interval

<!-- add confidence interval -->

<!-- ```{r} -->
<!-- list_dt_condition_coef = lapply(list_dt_condition_coef, function(dt_condition_coef){ -->
<!--   dt_condition_coef = dt_condition_coef[grep("perslab",module)] -->
<!--   dt_condition_coef[,lower:=qnorm(p=0.05/2, mean = estimate, sd=std.error)] -->
<!--   dt_condition_coef[,upper:=qnorm(p=1-0.05/2, mean = estimate, sd=std.error)] -->
<!-- }) -->
<!-- ``` -->

## celltypes and colors for plot

```{r}

vec_colors_cluster_perslab_coarse = readRDS(paste0(dirWGCNA_plots,prefixData,"_", prefixRun,  "_vec_colors_cluster_perslab_coarse.RDS"))

```

## module coefficient 

### coefficient plot v1: bar plot

CODE NEEDS UPDATING re: color vec and dt

```{r}
list_dt_condition_coef_sub = lapply(c("fibrosis","lob_inflam"), function(condition){
  
  condition_filter = if (condition=="fibrosis") quote(dt_condition_coef$condition=="fibrosis")  else quote(dt_condition_coef$condition=="lob_inflam")
  
  dt_condition_coef_sub = dt_condition_coef[eval(condition_filter) & p.value_percentile_BH < params$pValThreshold]
  # find matching cell type
  vec_celltype <- dt_geneMod_comb[[paste0("cell_cluster_", condition, "_gerhard2018")]][sapply(dt_condition_coef_sub$module, function(eachmod) grep(eachmod, gsub("-","_",dt_geneMod_comb[[paste0("module_", condition, "_gerhard2018")]]))[1])] 
  
  dt_condition_coef_sub[["celltype"]] = vec_celltype
  
  # order rows
  dt_condition_coef_sub = dt_condition_coef_sub[order(celltype,module)]
  orderToUse1 = 1:length(vec_celltype)
  # force row order with factors
  dt_condition_coef_sub[["celltype"]] = factor(dt_condition_coef_sub[["celltype"]], ordered = T)
  dt_condition_coef_sub[["celltype"]] = reorder(x=dt_condition_coef_sub[["celltype"]], X = orderToUse1, order=T)
  
  dt_condition_coef_sub[["module"]] = factor(dt_condition_coef_sub[["module"]], ordered = T) #factor(gsub("perslab_","",dt_condition_coef_sub[["module"]]), ordered = T)
  dt_condition_coef_sub[["module"]] = reorder(x=dt_condition_coef_sub[["module"]], X = orderToUse1, order=T)
  # color bars by cell type
  vec_color_celltype = vec_colors_cluster_perslab_coarse[vec_celltype]  %>% factor(.,ordered=T)

  #freqs = table(dt_condition_coef_sub[["celltype"]])

  #vec_color_tmp = rep(x = vec_color_unique_tmp, times = freqs) %>% factor(.,ordered=T)
  dt_condition_coef_sub[["color"]] = vec_color_celltype
  return(dt_condition_coef_sub)
})

names(list_dt_condition_coef_sub) = c("fibrosis","lob_inflam")
```

plot 

```{r}
lapply(c("fibrosis","lob_inflam"), function(condition) {
  dt_condition_coef_sub = list_dt_condition_coef_sub[[condition]]
  p <- 
    ggplot(data=dt_condition_coef_sub, aes(x=module, y=estimate_original, fill=celltype)) +
    geom_bar(stat="identity", position=position_identity(), group=dt_condition_coef_sub$celltype) + 
    #geom_errorbar(aes(ymin=estimate-std.error, ymax=estimate+std.error), width=.1) +
    geom_errorbar(aes(ymin=confInt_lower_percentile, ymax=confInt_upper_percentile), width=.1) +
    #scale_fill_brewer(palette="Paired")+
    scale_fill_manual(values=vec_colors_cluster_perslab_coarse[unique(dt_condition_coef_sub$celltype)]) + # this is a kluge
    #scale_fill_manual(values=unique(df_data$celltype)) + # this is a kluge
    #geom_hline(yintercept=cutoff, linetype="dashed", color = "red") +
    scale_y_continuous("estimate_original", expand = c(0, 0)) +
    scale_x_discrete("module") +  
    # geom_text(aes(label=module),
    #         #angle=90,
    #         #vjust=-1,
    #         hjust = 2,
    #         color="black",
    #         angle=90,
    #        position = position_dodge(), 
    #        size=2.5) +
    theme(axis.text.x = element_text(angle=90,hjust=1),#element_blank(),
        axis.line.x = element_blank(),
        axis.ticks.x = element_blank(),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank())
  
  saveMeta(savefnc=ggsave,plot = p,
           filename = paste0(dirWGCNA_plots,prefixData,"_", prefixRun,  "_sc_mod_", condition, "_assoc_gerhard_", params$date,".pdf"), height=10, width =15)
})
```


## alternative beta plot: scatterplot 

```{r}

data.table::dcast(data = dt_condition_coef[condition %in% c("fibrosis","lob_inflam")], formula= "module + estimate_original + confInt_lower_percentile + confInt_upper_percentile + p.value_percentile_BH~ condition", value.var = c("estimate_original", "confInt_lower_percentile", "confInt_upper_percentile", "p.value_percentile_BH"))

dt_fibrosis = dt_condition_coef[condition == "fibrosis"]
colnames(dt_fibrosis)[4:ncol(dt_fibrosis)] = paste0("fibrosis_",colnames(dt_fibrosis)[4:ncol(dt_fibrosis)])

dt_lob_inflam = dt_condition_coef[condition == "lob_inflam"]
colnames(dt_lob_inflam)[4:ncol(dt_lob_inflam)] = paste0("lob_inflam_",colnames(dt_lob_inflam)[4:ncol(dt_lob_inflam)])

dt_point = data.table::merge.data.table(x=dt_fibrosis, y= dt_lob_inflam, by="module", all=T)

# keep only modules significantly associated with a phenotype
dt_point = dt_point[lob_inflam_p.value_percentile_BH < params$pValThreshold | fibrosis_p.value_percentile_BH < params$pValThreshold]

dt_point = dt_point[!grepl("gerhard", module)]
dt_point$celltype = factor(gsub("_\\d+", "", dt_point$module), ordered=T)

vec_colors_cluster_perslab_coarse_red = vec_colors_cluster_perslab_coarse

names(vec_colors_cluster_perslab_coarse_red) = gsub("-","_",names(vec_colors_cluster_perslab_coarse_red))

vec_colors_cluster_perslab_coarse = vec_colors_cluster_perslab_coarse_red[names(vec_colors_cluster_perslab_coarse_red) %in% as.character(dt_point$celltype)]

vec_celltype_abbrev = c("Cholangiocytes"="Ch", "Dendritic_cells"="Den", "Endothelial_cells"="End", "Hepatic_stellate_cells"="Stel", "Hepatic_stem_cells"="Stem", "Hepatocytes"="Hep", "Macrophages"="Mac", "NK_like_cells"="NK", "T_cells_alpha_beta"="T_ab", "T_cells_gamma_delta"="T_gd")

dt_point[,module_number:=gsub("[^0-9]","",module)]
dt_point[,module_abbrev:=paste0(vec_celltype_abbrev[match(celltype,names(vec_celltype_abbrev))], module_number)]
```

```{r}
max_lim = round(max(abs(c(dt_point$lob_inflam_estimate_original,dt_point$fibrosis_estimate_original))), 0)+0.2
```

```{r}
set.seed(randomSeed)

p = ggplot(data=dt_point, mapping=aes(lob_inflam_estimate_original, fibrosis_estimate_original, color=celltype)) + 
  geom_point(size=4, alpha=0.8) + 
  
  scale_x_continuous(limits = c(-max_lim, max_lim)) + 
  scale_y_continuous(limits=c(-max_lim, max_lim)) +
  
  ggrepel::geom_text_repel(
  #geom_text(
      #nudge_x = -1.8-dt_point$lob_inflam#[lob_inflam_estimate_original>1 | fibrosis_estimate_original>1]$lob_inflam_estimate_original,  
      #nudge_y      = 0,
      direction    = "both",
      segment.color = "grey50",
      #angle        = 0,
      #hjust        = 0,
      point.padding=NA,
      segment.size = 0.2,
      data = dt_point,#[lob_inflam_estimate_original>1 | fibrosis_estimate_original>1],
      mapping = aes(
        #x=lob_inflam_estimate_original,
        #y= fibrosis_estimate_original,
        label=stringr::str_wrap(module_abbrev)),
        #color=dt_point[abs(lob_inflam_estimate_original)>0.8 | abs(fibrosis_estimate_original)>0.8]$color), 
      color="black",
      size=2.5, 
      #fontface="bold"
      ) +
  
   # 
   # ggrepel::geom_text_repel(
   #    nudge_x = 0.9-dt_point[lob_inflam_estimate_original<(-1) | fibrosis_estimate_original<(-1)]$lob_inflam_estimate_original,  
   #    nudge_y      = 0,
   #    direction    = "y",
   #    segment.color = "grey50",
   #    #angle        = 0,
   #    hjust        = 0,
   #    segment.size = 0.2,
   #    data = dt_point[lob_inflam_estimate_original<(-1) | fibrosis_estimate_original<(-1)],
   #    mapping = aes(
   #      x=lob_inflam_estimate_original,
   #      y= fibrosis_estimate_original,
   #      label=stringr::str_wrap(module)),
   #      #color=dt_point[abs(lob_inflam_estimate_original)>0.8 | abs(fibrosis_estimate_original)>0.8]$color), 
   #    color="black",
   #    size=2.5, 
   #    #fontface="bold"
   #    ) +
  
  #labs(x = "z-score", y="-log(p-value)", colour="z-score") +
  labs(x = "lobular inflammation", y="fibrosis") +
  
  scale_color_manual(
    values=vec_colors_cluster_perslab_coarse_red) +#,
    #labels=levels(dt_point$celltype)) + 
  geom_hline(yintercept = 0, size=0.1) +
  geom_vline(xintercept = 0, size=0.1) + 
  theme(axis.text = element_text(size = 9), 
        axis.line = element_line(colour = "grey80"), 
        axis.ticks = element_line(colour = "grey80"), 
        #axis.title = element_text(size = 9),#, face = "bold"), 
        panel.background = element_blank(), 
        #legend.position = "none",
        #panel.grid.minor = element_blank(), 
        #panel.grid.major = element_line(colour = "grey80"), 
        plot.background = element_blank(), 
        panel.grid = element_blank(),
        text = element_text(size = 9),
        legend.title=element_blank()) 
    # geom_text(aes(label=stringr::str_wrap(module)),color="black", size=2)
  
```

====================================================================

## featureplot of module embeddings


```{r}

#p = FeaturePlot(object = seuratObj, features = "")
```






```{r}
Idents(seuratObj) <- seuratObj$cluster_perslab_coarse

seuratObj_sub <- subset(x=seuratObj,
                    idents=vec_celltypesOfInterest)
```

### load gene module cell embedding matrix

we will need to compute embeddings of all modules - including bulk - in sc

<!-- ```{r} -->
<!-- path_dt_embed_gerhard <- paste0(dirWGCNA_tables, "moylan2013","_","wgcna1","_modules_sc_cellModEmbed.csv") -->
<!-- dt_embed_moylan2013 <- fread(path_dt_embed_moylan2013) -->
<!-- dt_embed_moylan2013[0:4,0:5] -->

<!-- ``` -->

cbind embeddings

```{r}
colnames(dt_embed_moylan2013)[2:ncol(dt_embed_moylan2013)] <- paste0("moylan2013__",colnames(dt_embed_moylan2013)[2:ncol(dt_embed_moylan2013)])
```

```{r}
dt_embed <- cbind(dt_embed_sc,dt_embed_moylan2013)
```

filter embeddings to celltypes of interest GOT TO HERE

```{r}

vec_celltypesOfInterest %>% gsub("-","_",.) %>% lapply(., function(eachName) grepl(eachName,colnames(dt_embed_sc))) %>% Reduce(f = '|',x=.) %>% which -> vec_colsOfInterest

```

```{r}
dt_embed_sc_sub <- dt_embed_sc[,c(1:3, ..vec_colsOfInterest),]

colnames(dt_embed_sc_sub)
```

```{r}
dim(dt_embed_sc_sub)
#[1] 21007   130
```

127 modules

<!-- ```{r} -->
<!-- dt_embed_sc_meta <- fread(here("output", paste0(prefixData, "_" , prefixRun, "_", prefixOut, "_cellModEmbed_meta.csv"))) -->
<!-- ``` -->







```{r}
path_dt_metadataCombined <- here("data", "metadataCombined.csv")
dt_metadataCombined<-fread(file=path_dt_metadataCombined)

head(dt_metadataCombined)

#   ID      Age Sex Ethnicity      BMI Smoking Alcohol_use nas_sum fibrosis_grade lobular_inflammation_grade
# 1: 235L 44.55068   0    Danish 35.15850       1           1       6              2                          2
# 2: 242L 53.32055   1    Danish 37.48722       0           2       5              1                          2
# 3: 245L 43.53973   1    Danish 44.48491       1           1       5              2                          2
# 4: 247L 51.12603   0    Danish 52.65934       1           1       5              2                          2
# 5: 249L 64.40822   0    Danish 44.47846       1           1       4              2                          3
# 6: 252L 47.02192   1    Danish 44.85055       1           1       5              2                          2
```

```{r}
#load("/projects/jonatan/pub-perslab/18-liver-wgcna/RObjects/liver_perslab_int_wgcna1_final_session_image.RData.gz")
```

load data table from metadata association analysis 

```{r}
path_dt_metadataAssoc <- here("output", paste0(prefixData, "_" , prefixRun, "_moylan2013_wgcna_assoc_results.csv"))
dt_metadataAssoc <- fread(path_dt_metadataAssoc)
dt_metadataAssoc
```

# Analysis and plotting

Generate a lookup table for module - cell type 

```{r}
dt_geneModDict <- dt_geneMod[!duplicated(dt_geneMod[[colModule]]),]
```

```{r}
dt_geneModDict[[colModule]] %>% na.omit %>% length
# [1] 110
```


## correlation matrix 

Very high correlations between gene modules could indicate confounding

Even if serious confounding is not suspected, it may make sense to try to merge very overlapping and correlated modules across cell types, which the current cell-type-wise WGCNA workflow does not do.

## correlation matrix 

```{r}
mat_modCor <- cor(x=dt_embed_sc_sub[,-c("data", "cell_cluster", "cell_id")],
                               use="pairwise.complete.obs",
                               method="pearson")

```

```{r}

pdf(file = here("plots", paste0(prefixData, "_" , prefixRun, "_", prefixOut, "_", flagDate, "_moduleCorr.pdf")), width=20, height=20)
corrplot::corrplot(corr = mat_modCor, method="number", number.cex = 0.5)
dev.off()
```

#TODO: 

## Hierarchically cluster modules

plot the eigengene (kIM embeddings) correlations 

```{r}

#http://www.sthda.com/english/wiki/beautiful-dendrogram-visualizations-in-r-5-must-known-methods-unsupervised-machine-learning

t(dt_embed_sc[,4:ncol(dt_embed_sc)]) %>% # data
  scale %>% # Scale the data
  dist %>% # calculate a distance matrix, 
  hclust(method = "ward.D2") -> hc # Hierarchical clustering 

dend <- as.dendrogram(hc) # Turn the object into a dendrogram.

plot(dend)
```

```{r}
dendextend::get_leaves_attr(attribute = "label", dend=dend)
```

<!-- ```{r} -->
<!-- dend %>%  -->
<!--   set(what="labels_col", value=dendextend::get_leaves_attr(attribute = "label", dend=dend)) -> dend # change leaf colors -->
<!--   #set("leaves_pch", rep(c(1:length(unique(dt_geneMod$cell_cluster))),table(dt_geneModDict$cell_cluster)))  # node point type for cell type -->

<!-- #plot(dend) -->
<!-- ``` -->

```{r}

vec_cellCluster_integer <- brewer.pal(n = length(unique(dt_geneMod[[colCellCluster]])), name="Spectral")
names(vec_cellCluster_integer) <- unique(dt_geneMod[[colCellCluster]])

dend %>% 
  set(what="leaves_pch", value=19) %>%
  set(what="leaves_cex", 2) %>% 
  set(what="leaves_col", value=vec_cellCluster_integer[match(dt_geneModDict[[colCellCluster]][match(get_leaves_attr(attribute = "label", dend=dend), dt_geneModDict[[colModule]])], names(vec_cellCluster_integer))]) -> 
  dend

plot(dend)
```

## Module-module correlation matrix 

```{r}
#TODO
```

## Plot the embeddings in UMAP

group plots per celltype 

```{r}
list_vec_modulesSignif <- lapply(unique(dt_metadataAssoc[,cell_cluster,]), function(cell_clust) {
  dt_metadataAssoc[cell_cluster==cell_clust & 
                     p.adjust(p.value, method = pAdjMethod) <= pValThreshold, "module"][[1]]
  })

names(list_vec_modulesSignif) <- unique(dt_metadataAssoc[,cell_cluster,])

list_vec_modulesSignif
```

```{r}

dt_metaTmp <- dt_embed_sc[,-"cell_id",]
rownames(dt_metaTmp) <- dt_embed_sc[,cell_id,]
all.equal(rownames(dt_metaTmp), colnames(seuratObj))

#[1] TRUE

```

```{r}
seuratObj <- AddMetaData(object = seuratObj, 
                         metadata = dt_metaTmp)
```

```{r}

invisible(lapply(names(list_vec_modulesSignif), function(cell_cluster) {
  
  vec_modulesSignif = list_vec_modulesSignif[[cell_cluster]]
  
  list_featPlot <- lapply(vec_modulesSignif, function(module) {
    FeaturePlot(object = seuratObj, 
                features = module, 
                reduction = "umap", pt.size = .1)
    }
    )
  
  p1<- cowplot::plot_grid(plotlist = list_featPlot,
                          ncol= (list_featPlot %>% length %>% sqrt %>% as.integer),
                          labels=NULL)#as.list(vec_modulesSignif))
  
  saveMeta(savefnc = cowplot::save_plot, 
           plot=p1,
            ncol= (list_featPlot %>% length %>% sqrt %>% as.integer),
            filename =  here("plots",paste0(prefixData, "_", prefixRun, "_", prefixOut, "_", cell_cluster, "_wgcnaModuleUMAPembeddings.pdf")),
            base_height = 15, # of a subplot
            #base_width = 5,
            base_aspect_ratio = 0.3,
            limitsize=F)
}))
```

## gene module heatmaps

The gene module embeddings are computed using the SC- normalized counts. 
Hence we need to z-score them to plot on a single heatmap

First order the rows by cell cluster

```{r}
dt_embed_sc[,cell_cluster:=dt_embed_sc_meta[,"cell_cluster",]]
dt_embed_sc <- dt_embed_sc[order(cell_cluster)]
```

```{r}
vec_modulesSignif = colnames(dt_embed_sc)
vec_modulesSignif = vec_modulesSignif[!vec_modulesSignif %in% c("cell_id", "cell_cluster")]

dt_embed_sc[,lapply(.SD, scale),, .SDcols=vec_modulesSignif] %>% as.matrix -> mat_cellModEmbed_scaled 

rownames(mat_cellModEmbed_scaled) <- dt_embed_sc[,c("cell_id")][[1]]
```

Find locations for labels halfway through cell types in rows
```{r}
vec_table <- table(dt_embed_sc[,cell_cluster,])
vec_cumsum <- cumsum(c(1,vec_table)) 
vec_pos <- sapply(2:length(vec_cumsum), function(i) {
  as.integer(vec_cumsum[i-1]+vec_table[i-1]/2)
})
```


```{r}
set.seed(randomSeed)
colorvec = sample(x=unique(gsub("\\d","",colors())), size=length(unique(dt_metadataAssoc[,cell_cluster,])), replace=F)
names(colorvec) =unique(dt_metadataAssoc[,cell_cluster,])
```

```{r}
pdf(file = here("plots", paste0(prefixData, "_" , prefixRun, "_", prefixOut, "_modEmbedHeatmap.pdf")), width=20, height=20)
p <- ComplexHeatmap::Heatmap(mat=mat_cellModEmbed_scaled, 
                             name="Module embeddings",
                             row_title = "cell",
                             column_title = "gene module",
                             cluster_rows = FALSE,
                             #cluster_cols = FALSE,
                             show_row_names=FALSE) 



p <- p + rowAnnotation(cell_cluster = dt_embed_sc$cell_cluster,
    col = list(cell_cluster = colorvec))

# p <- p + columnAnnotation(cell_cluster = dt_geneModDict$cell_cluster[match(vec_modulesSignif,dt_geneModDict$module)],
#     col = list(cell_cluster = colorvec))

# p <- p+ rowAnnotation(foo = anno_link(at = vec_pos, which="row", side="right",
#                     labels = names(vec_table)))
draw(p)
dev.off()
```

## Module - cell cluster specificity

```{r}
#TODO
# NOT PRIORITY
```



### LEFTOVERS FROM LIVER MODULE SC QC  - CHECK ! ###

# QC plotting



The gene module embeddings are computed using the SC- normalized and ComBat corrected counts. 
Hence we need to z-score them to plot on a single heatmap

```{r}
dt_embed_sc_sub[,lapply(.SD, scale),, .SDcols=colnames(dt_embed_sc_sub[,-c("data", "cell_cluster", "cell_id")])] %>% as.matrix -> mat_cellModEmbed_sub_scaled 

colnames(mat_cellModEmbed_sub_scaled) %>% gsub("\\.V1","", .) -> colnames(mat_cellModEmbed_sub_scaled)

rownames(mat_cellModEmbed_sub_scaled) <- dt_embed_sc_sub[,c("cell_id")][[1]]

mat_cellModEmbed_sub_scaled[0:4,0:4]

#                   Cholangiocytes__aliceblue.V1 Cholangiocytes__azure2.V1 Cholangiocytes__black.V1 Cholangiocytes__chocolate.V1
# TGTCCCACAATGAATG_1                    2.4859331              -0.009620634             -0.001129782                 -0.007353158
# AAACGGGGTCTACCTC_1                    0.7263057              -0.009620634             -0.001129782                 -0.007353158
# AAGTCTGGTAATAGCA_1                   -1.6010004              -0.009620634             -0.001129782                 -0.007353158
# AATCGGTCATGATCCA_1                    3.4825015              -0.009620634             -0.001129782                 -0.007353158
```

<!-- Find locations for cell type labels halfway through cell types in rows -->

<!-- ```{r} -->
<!-- vec_cellClustTable <- table(dt_embed_sc_sub[,cell_cluster,]) -->
<!-- vec_cellClustCumsum <- cumsum(c(1,vec_cellClustTable))  -->
<!-- vec_cellClustPos <- sapply(2:length(vec_cellClustCumsum), function(i) { -->
<!--   as.integer(vec_cellClustCumsum[i-1]+vec_cellClustTable[i-1]/2) -->
<!-- }) -->
<!-- ``` -->

make colors to identify cell clusters in row annotation

```{r}
set.seed(randomSeed)
vec_colorCellClust = sample(x=unique(gsub("\\d","",colors())), size=length(unique(dt_embed_sc_sub[,cell_cluster,])), replace=F)
names(vec_colorCellClust) =unique(dt_embed_sc_sub[,cell_cluster,])
vec_colorCellClust
```

make colors to identify sample_ID in row annotation

```{r}
set.seed(randomSeed)
vec_colorSampleID = sample(x=unique(gsub("\\d","",colors())), size=length(unique(seuratObj_sub$sample_ID)), replace=F)
names(vec_colorSampleID) =unique(seuratObj_sub$sample_ID)
vec_colorSampleID

```
<!-- Find locations for labels halfway through sample_ID in rows -->

<!-- ```{r} -->

<!-- vec_cellClustTable <- table(dt_embed_sc_sub[,cell_cluster,]) -->
<!-- vec_cellClustCumsum <- cumsum(c(1,vec_cellClustTable))  -->
<!-- vec_cellClustPos <- sapply(2:length(vec_cellClustCumsum), function(i) { -->
<!--   as.integer(vec_cellClustCumsum[i-1]+vec_cellClustTable[i-1]/2) -->
<!-- }) -->
<!-- ``` -->

```{r}
pdf(file = here("plots", paste0(prefixData, "_" , prefixRun, "_", prefixOut, "_", flagDate, "_modEmbedHeatmap.pdf")), width=20, height=20)
p <- ComplexHeatmap::Heatmap(mat=mat_cellModEmbed_sub_scaled, 
                             name="Module embeddings",
                             row_title = "cell",
                             column_title = "gene module",
                             cluster_rows = FALSE,
                             #cluster_cols = FALSE,
                             show_row_names=FALSE,
                             use_raster = TRUE, 
                             raster_quality = 2) 



p <- p + HeatmapAnnotation(cell_cluster = dt_embed_sc_sub$cell_cluster,
    col = list(cell_cluster = vec_colorCellClust) ,
    which="row")

p <- p + HeatmapAnnotation(df = data.frame("sample_ID" = seuratObj_sub$sample_ID[match(dt_embed_sc_sub$cell_id, rownames(seuratObj_sub@meta.data))]),
    col = list(sample_ID = vec_colorSampleID),
    which="row")

# p <- p + HeatmapAnnotation(df = data.frame("cell_cluster" = mat_cellModEmbed_sub_scaled %>% colnames %>% gsub("__.*$","", .)),
#                            col = list(cell_cluster = vec_colorCellClust), 
#                            which="column")


draw(p)
dev.off()
```

