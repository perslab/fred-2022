---
title: 'Liver - gene network plots'
author: "Jon Thompson, Pers lab, rkm916 at ku dot dk"
date: "`r Sys.time()`" 
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
params: 
  date: !r substr(gsub("-","",as.character(Sys.Date())),3,1000)
  randomSeed: !r 12345
  pValThreshold: !r 0.05
# output:
#   html_notebook:
#     df_print: paged
#     number_sections: yes
#     toc: yes
#     toc_depth: 3
#     toc_float: yes
#   html_document:
#     df_print: paged
#     number_sections: yes
#     toc: yes
#     toc_depth: 3
#     toc_float: yes
---

# Setup

## Set options

```{r}
options(stringsAsFactors = F, 
        use="pairwise.complete.obs", 
        warn=1, 
        verbose=F,
        mc.cores=40 # for parallel computation
        ) 
```

```{r}
randomSeed = 12345
set.seed(randomSeed)

pAdjMethod = "BH"
pValThreshold = 0.05 #params$pValThreshold

flagDate = substr(gsub("-","",as.character(Sys.Date())),3,1000)
```

## Load packages

```{r}
#ipak(c("Seurat", "dplyr", "ggplot2", "Matrix", "parallel", "readr", "tidyr"))
library("Seurat")
library("data.table")
library("dplyr")
library("ggplot2")
library("Matrix")
library("parallel")
#library("readr")
library("tidyr")
library("here")
#library("lme4")
#library("WGCNA")
#library("dendextend")
#library("ggdendro")
library("ComplexHeatmap")
library("corrplot")
#devtools::install_github(repo = "satijalab/seurat", ref = "develop")
```

## source utility functions

```{r}
source(here("perslab-sc-library", "utility_functions.R"))
source(here("perslab-sc-library", "functions_sc.R"))
```

## Set constants

generic project constants 

```{r}
#prefixData <- "aizarani"
prefixData = "liver_perslab_int"
prefixRun = "seurat_7"
prefixRunWGCNA = "wgcna3"
prefixOut <- "SCTint"

dirWGCNA_outs = "/projects/jonatan/pub-perslab/18-liver-wgcna/"
dirWGCNA_plots = paste0(dirWGCNA_outs, "plots/" )
dirWGCNA_RObjects = paste0(dirWGCNA_outs, "RObjects/" )
dirWGCNA_tables = paste0(dirWGCNA_outs, "tables/" )

colModule = "module_pres"
colCellCluster = "cell_cluster_pres"
```

we are interested in a subset of the "cluster_perslab_coarse" cell types

```{r}
vec_celltypesOfInterest <- c("T-cells-alpha-beta",
                             "NK-like-cells",
                             "Endothelial-cells",
                             "T-cells-gamma-delta", 
                             "Macrophages",  
                             "Cholangiocytes",        
                             "Hepatocytes",
                             "Hepatic-stellate-cells", 
                             "Dendritic-cells", 
                             "Hepatic-stem-cells")
```

## load data

Seurat object contains expression data and cell + patient-level metadata

```{r}
# path_seuratObj <- here("output", paste0(prefixData, "_", prefixRun, "_", prefixOut, "_perslab_labels_seuratObj.RDS.gz"))
path_seuratObj <- here("output", paste0(prefixData, "_", prefixRun, "_", prefixOut, "_perslab_labels_seuratObj.RDS.gz"))

seuratObj <- load_obj(path_seuratObj)
```

```{r}
Idents(seuratObj) <- seuratObj$cluster_perslab_coarse

seuratObj_sub <- subset(x=seuratObj,
                    idents=vec_celltypesOfInterest)
```

load gene module cell embedding matrices

```{r}
path_dt_embed_sc <-  paste0(dirWGCNA_tables, prefixData, "_",prefixRunWGCNA,"_kIM_cellModEmbed.csv.gz")
dt_embed_sc <- fread(path_dt_embed_sc)
dt_embed_sc[0:4,0:5]
```

```{r}
path_dt_embed_moylan2013 <- paste0(dirWGCNA_tables, "moylan2013","_","wgcna1","_modules_sc_cellModEmbed.csv")
dt_embed_moylan2013 <- fread(path_dt_embed_moylan2013)
dt_embed_moylan2013[0:4,0:5]

```

cbind embeddings

```{r}
colnames(dt_embed_moylan2013)[2:ncol(dt_embed_moylan2013)] <- paste0("moylan2013__",colnames(dt_embed_moylan2013)[2:ncol(dt_embed_moylan2013)])
```

```{r}
dt_embed <- cbind(dt_embed_sc,dt_embed_moylan2013)
```

filter embeddings to celltypes of interest GOT TO HERE

```{r}

vec_celltypesOfInterest %>% gsub("-","_",.) %>% lapply(., function(eachName) grepl(eachName,colnames(dt_embed_sc))) %>% Reduce(f = '|',x=.) %>% which -> vec_colsOfInterest

```

```{r}
dt_embed_sc_sub <- dt_embed_sc[,c(1:3, ..vec_colsOfInterest),]

colnames(dt_embed_sc_sub)
```

```{r}
dim(dt_embed_sc_sub)
#[1] 21007   130
```

127 modules

<!-- ```{r} -->
<!-- dt_embed_sc_meta <- fread(here("output", paste0(prefixData, "_" , prefixRun, "_", prefixOut, "_cellModEmbed_meta.csv"))) -->
<!-- ``` -->

load data frame with information on module and cell type of origin

```{r}
path_geneMod <- paste0(dirWGCNA_tables,"liver_perslab_int_", prefixRunWGCNA,"_geneMod_merged.csv.gz")
  
dt_geneMod <-fread(file=path_geneMod)

dt_geneMod[1,]

#                 data    run   cell_cluster     module         genes      pkMs
# 1: liver_perslab_int wgcna2 B_cells_mature indianred3 RP13-580B18.4 0.4231437

```

```{r}
vec_celltypesOfInterest %>% gsub("-","_",.) -> vec_tmp
dt_geneMod_sub <- dt_geneMod[,module %in% ..vec_tmp,]
```

```{r}
path_dt_metadataCombined <- here("data", "metadataCombined.csv")
dt_metadataCombined<-fread(file=path_dt_metadataCombined)

head(dt_metadataCombined)

#   ID      Age Sex Ethnicity      BMI Smoking Alcohol_use nas_sum fibrosis_grade lobular_inflammation_grade
# 1: 235L 44.55068   0    Danish 35.15850       1           1       6              2                          2
# 2: 242L 53.32055   1    Danish 37.48722       0           2       5              1                          2
# 3: 245L 43.53973   1    Danish 44.48491       1           1       5              2                          2
# 4: 247L 51.12603   0    Danish 52.65934       1           1       5              2                          2
# 5: 249L 64.40822   0    Danish 44.47846       1           1       4              2                          3
# 6: 252L 47.02192   1    Danish 44.85055       1           1       5              2                          2
```

```{r}
#load("/projects/jonatan/pub-perslab/18-liver-wgcna/RObjects/liver_perslab_int_wgcna1_final_session_image.RData.gz")
```

load data table from metadata association analysis 

```{r}
path_dt_metadataAssoc <- here("output", paste0(prefixData, "_" , prefixRun, "_moylan2013_wgcna_assoc_results.csv"))
dt_metadataAssoc <- fread(path_dt_metadataAssoc)
dt_metadataAssoc
```

# Analysis and plotting

Generate a lookup table for module - cell type 

```{r}
dt_geneModDict <- dt_geneMod[!duplicated(dt_geneMod[[colModule]]),]
```

```{r}
dt_geneModDict[[colModule]] %>% na.omit %>% length
# [1] 110
```


## correlation matrix 

Very high correlations between gene modules could indicate confounding

Even if serious confounding is not suspected, it may make sense to try to merge very overlapping and correlated modules across cell types, which the current cell-type-wise WGCNA workflow does not do.

## correlation matrix 

```{r}
mat_modCor <- cor(x=dt_embed_sc_sub[,-c("data", "cell_cluster", "cell_id")],
                               use="pairwise.complete.obs",
                               method="pearson")

```

```{r}

pdf(file = here("plots", paste0(prefixData, "_" , prefixRun, "_", prefixOut, "_", flagDate, "_moduleCorr.pdf")), width=20, height=20)
corrplot::corrplot(corr = mat_modCor, method="number", number.cex = 0.5)
dev.off()
```

#TODO: 

## Hierarchically cluster modules

plot the eigengene (kIM embeddings) correlations 

```{r}

#http://www.sthda.com/english/wiki/beautiful-dendrogram-visualizations-in-r-5-must-known-methods-unsupervised-machine-learning

t(dt_embed_sc[,4:ncol(dt_embed_sc)]) %>% # data
  scale %>% # Scale the data
  dist %>% # calculate a distance matrix, 
  hclust(method = "ward.D2") -> hc # Hierarchical clustering 

dend <- as.dendrogram(hc) # Turn the object into a dendrogram.

plot(dend)
```

```{r}
dendextend::get_leaves_attr(attribute = "label", dend=dend)
```

<!-- ```{r} -->
<!-- dend %>%  -->
<!--   set(what="labels_col", value=dendextend::get_leaves_attr(attribute = "label", dend=dend)) -> dend # change leaf colors -->
<!--   #set("leaves_pch", rep(c(1:length(unique(dt_geneMod$cell_cluster))),table(dt_geneModDict$cell_cluster)))  # node point type for cell type -->

<!-- #plot(dend) -->
<!-- ``` -->

```{r}

vec_cellCluster_integer <- brewer.pal(n = length(unique(dt_geneMod[[colCellCluster]])), name="Spectral")
names(vec_cellCluster_integer) <- unique(dt_geneMod[[colCellCluster]])

dend %>% 
  set(what="leaves_pch", value=19) %>%
  set(what="leaves_cex", 2) %>% 
  set(what="leaves_col", value=vec_cellCluster_integer[match(dt_geneModDict[[colCellCluster]][match(get_leaves_attr(attribute = "label", dend=dend), dt_geneModDict[[colModule]])], names(vec_cellCluster_integer))]) -> 
  dend

plot(dend)
```

## Module-module correlation matrix 

```{r}
#TODO
```

## Plot the embeddings in UMAP

group plots per celltype 

```{r}
list_vec_modulesSignif <- lapply(unique(dt_metadataAssoc[,cell_cluster,]), function(cell_clust) {
  dt_metadataAssoc[cell_cluster==cell_clust & 
                     p.adjust(p.value, method = pAdjMethod) <= pValThreshold, "module"][[1]]
  })

names(list_vec_modulesSignif) <- unique(dt_metadataAssoc[,cell_cluster,])

list_vec_modulesSignif
```

```{r}

dt_metaTmp <- dt_embed_sc[,-"cell_id",]
rownames(dt_metaTmp) <- dt_embed_sc[,cell_id,]
all.equal(rownames(dt_metaTmp), colnames(seuratObj))

#[1] TRUE

```

```{r}
seuratObj <- AddMetaData(object = seuratObj, 
                         metadata = dt_metaTmp)
```

```{r}

invisible(lapply(names(list_vec_modulesSignif), function(cell_cluster) {
  
  vec_modulesSignif = list_vec_modulesSignif[[cell_cluster]]
  
  list_featPlot <- lapply(vec_modulesSignif, function(module) {
    FeaturePlot(object = seuratObj, 
                features = module, 
                reduction = "umap", pt.size = .1)
    }
    )
  
  p1<- cowplot::plot_grid(plotlist = list_featPlot,
                          ncol= (list_featPlot %>% length %>% sqrt %>% as.integer),
                          labels=NULL)#as.list(vec_modulesSignif))
  
  saveMeta(savefnc = cowplot::save_plot, 
           plot=p1,
            ncol= (list_featPlot %>% length %>% sqrt %>% as.integer),
            filename =  here("plots",paste0(prefixData, "_", prefixRun, "_", prefixOut, "_", cell_cluster, "_wgcnaModuleUMAPembeddings.pdf")),
            base_height = 15, # of a subplot
            #base_width = 5,
            base_aspect_ratio = 0.3,
            limitsize=F)
}))
```

## gene module heatmaps

The gene module embeddings are computed using the SC- normalized counts. 
Hence we need to z-score them to plot on a single heatmap

First order the rows by cell cluster

```{r}
dt_embed_sc[,cell_cluster:=dt_embed_sc_meta[,"cell_cluster",]]
dt_embed_sc <- dt_embed_sc[order(cell_cluster)]
```

```{r}
vec_modulesSignif = colnames(dt_embed_sc)
vec_modulesSignif = vec_modulesSignif[!vec_modulesSignif %in% c("cell_id", "cell_cluster")]

dt_embed_sc[,lapply(.SD, scale),, .SDcols=vec_modulesSignif] %>% as.matrix -> mat_cellModEmbed_scaled 

rownames(mat_cellModEmbed_scaled) <- dt_embed_sc[,c("cell_id")][[1]]
```

Find locations for labels halfway through cell types in rows
```{r}
vec_table <- table(dt_embed_sc[,cell_cluster,])
vec_cumsum <- cumsum(c(1,vec_table)) 
vec_pos <- sapply(2:length(vec_cumsum), function(i) {
  as.integer(vec_cumsum[i-1]+vec_table[i-1]/2)
})
```


```{r}
set.seed(randomSeed)
colorvec = sample(x=unique(gsub("\\d","",colors())), size=length(unique(dt_metadataAssoc[,cell_cluster,])), replace=F)
names(colorvec) =unique(dt_metadataAssoc[,cell_cluster,])
```

```{r}
pdf(file = here("plots", paste0(prefixData, "_" , prefixRun, "_", prefixOut, "_modEmbedHeatmap.pdf")), width=20, height=20)
p <- ComplexHeatmap::Heatmap(mat=mat_cellModEmbed_scaled, 
                             name="Module embeddings",
                             row_title = "cell",
                             column_title = "gene module",
                             cluster_rows = FALSE,
                             #cluster_cols = FALSE,
                             show_row_names=FALSE) 



p <- p + rowAnnotation(cell_cluster = dt_embed_sc$cell_cluster,
    col = list(cell_cluster = colorvec))

# p <- p + columnAnnotation(cell_cluster = dt_geneModDict$cell_cluster[match(vec_modulesSignif,dt_geneModDict$module)],
#     col = list(cell_cluster = colorvec))

# p <- p+ rowAnnotation(foo = anno_link(at = vec_pos, which="row", side="right",
#                     labels = names(vec_table)))
draw(p)
dev.off()
```

## Module - cell cluster specificity

```{r}
#TODO
# NOT PRIORITY
```



### LEFTOVERS FROM LIVER MODULE SC QC  - CHECK ! ###

# QC plotting



The gene module embeddings are computed using the SC- normalized and ComBat corrected counts. 
Hence we need to z-score them to plot on a single heatmap

```{r}
dt_embed_sc_sub[,lapply(.SD, scale),, .SDcols=colnames(dt_embed_sc_sub[,-c("data", "cell_cluster", "cell_id")])] %>% as.matrix -> mat_cellModEmbed_sub_scaled 

colnames(mat_cellModEmbed_sub_scaled) %>% gsub("\\.V1","", .) -> colnames(mat_cellModEmbed_sub_scaled)

rownames(mat_cellModEmbed_sub_scaled) <- dt_embed_sc_sub[,c("cell_id")][[1]]

mat_cellModEmbed_sub_scaled[0:4,0:4]

#                   Cholangiocytes__aliceblue.V1 Cholangiocytes__azure2.V1 Cholangiocytes__black.V1 Cholangiocytes__chocolate.V1
# TGTCCCACAATGAATG_1                    2.4859331              -0.009620634             -0.001129782                 -0.007353158
# AAACGGGGTCTACCTC_1                    0.7263057              -0.009620634             -0.001129782                 -0.007353158
# AAGTCTGGTAATAGCA_1                   -1.6010004              -0.009620634             -0.001129782                 -0.007353158
# AATCGGTCATGATCCA_1                    3.4825015              -0.009620634             -0.001129782                 -0.007353158
```

<!-- Find locations for cell type labels halfway through cell types in rows -->

<!-- ```{r} -->
<!-- vec_cellClustTable <- table(dt_embed_sc_sub[,cell_cluster,]) -->
<!-- vec_cellClustCumsum <- cumsum(c(1,vec_cellClustTable))  -->
<!-- vec_cellClustPos <- sapply(2:length(vec_cellClustCumsum), function(i) { -->
<!--   as.integer(vec_cellClustCumsum[i-1]+vec_cellClustTable[i-1]/2) -->
<!-- }) -->
<!-- ``` -->

make colors to identify cell clusters in row annotation

```{r}
set.seed(randomSeed)
vec_colorCellClust = sample(x=unique(gsub("\\d","",colors())), size=length(unique(dt_embed_sc_sub[,cell_cluster,])), replace=F)
names(vec_colorCellClust) =unique(dt_embed_sc_sub[,cell_cluster,])
vec_colorCellClust
```

make colors to identify sample_ID in row annotation

```{r}
set.seed(randomSeed)
vec_colorSampleID = sample(x=unique(gsub("\\d","",colors())), size=length(unique(seuratObj_sub$sample_ID)), replace=F)
names(vec_colorSampleID) =unique(seuratObj_sub$sample_ID)
vec_colorSampleID

```
<!-- Find locations for labels halfway through sample_ID in rows -->

<!-- ```{r} -->

<!-- vec_cellClustTable <- table(dt_embed_sc_sub[,cell_cluster,]) -->
<!-- vec_cellClustCumsum <- cumsum(c(1,vec_cellClustTable))  -->
<!-- vec_cellClustPos <- sapply(2:length(vec_cellClustCumsum), function(i) { -->
<!--   as.integer(vec_cellClustCumsum[i-1]+vec_cellClustTable[i-1]/2) -->
<!-- }) -->
<!-- ``` -->

```{r}
pdf(file = here("plots", paste0(prefixData, "_" , prefixRun, "_", prefixOut, "_", flagDate, "_modEmbedHeatmap.pdf")), width=20, height=20)
p <- ComplexHeatmap::Heatmap(mat=mat_cellModEmbed_sub_scaled, 
                             name="Module embeddings",
                             row_title = "cell",
                             column_title = "gene module",
                             cluster_rows = FALSE,
                             #cluster_cols = FALSE,
                             show_row_names=FALSE,
                             use_raster = TRUE, 
                             raster_quality = 2) 



p <- p + HeatmapAnnotation(cell_cluster = dt_embed_sc_sub$cell_cluster,
    col = list(cell_cluster = vec_colorCellClust) ,
    which="row")

p <- p + HeatmapAnnotation(df = data.frame("sample_ID" = seuratObj_sub$sample_ID[match(dt_embed_sc_sub$cell_id, rownames(seuratObj_sub@meta.data))]),
    col = list(sample_ID = vec_colorSampleID),
    which="row")

# p <- p + HeatmapAnnotation(df = data.frame("cell_cluster" = mat_cellModEmbed_sub_scaled %>% colnames %>% gsub("__.*$","", .)),
#                            col = list(cell_cluster = vec_colorCellClust), 
#                            which="column")


draw(p)
dev.off()
```

